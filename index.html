<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pemberi Kerja/Badan Usaha Kantor Cabang Medan Kota</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #004c99; /* Biru BPJS */
            --color-secondary: #0066cc; /* Biru Terang */
            --color-green: #28a745;    /* Hijau Awal */
            --color-yellow-accent: #ffc107; /* Kuning (untuk highlight/warning) */
            --color-background: #f0f3f6; /* Abu-abu Muda */
            --color-surface: #ffffff; /* Putih */
            --color-text-dark: #333333;
            --color-text-light: #ffffff;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Shadow lebih kecil */
            --border-radius: 8px; /* Radius lebih kecil */
            --font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-dark);
            min-height: 100vh;
            padding: 10px; 
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            /* Lebar container dibatasi agar tidak terlalu lebar di layar besar */
            max-width: 1200px; 
            margin: 0 auto;
            flex-grow: 1;
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--color-surface);
            padding: 5px 0; 
            border-bottom: 1px solid #e0e0e0; 
        }

        .header-section {
            display: flex;
            align-items: center;
        }

        .header-logo {
            height: 70px; /* NILAI DITINGKATKAN DARI 50px MENJADI 70px */
            margin-right: 8px;
            border-radius: 6px;
        }
            
        .header-logo:last-of-type {
            margin-right: 0;
        }

        .header-title {
            text-align: center;
            flex-grow: 1;
        }
            
        .header-title h1 {
            font-size: 1.1rem; 
            color: var(--color-primary);
            font-weight: 700;
            margin-bottom: 3px;
        }
            
        .header-title p {
            font-size: 0.8rem; 
            font-weight: 500;
            color: #000000;
            font-style: italic;
        }

        .header-person {
            height: 35px; 
            margin-left: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--color-green), #20c997); /* Gradasi Hijau */
            color: var(--color-text-light);
            padding: 8px 15px; /* Padding sedikit lebih besar */
            margin-bottom: 5px; 
            font-weight: 500;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-size: 1em; 
        }
            
        .top-bar-left {
            display: flex;
            align-items: center;
            font-size: 0.9rem; /* UKURAN FONT TANGGAL DIKECILKAN */
            font-weight: 700; /* Tetap tebal */
        }

        .top-bar-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .nav-button {
            display: inline-block;
            margin: 0 5px; 
            padding: 6px 15px; 
            font-size: 0.9em;
            color: var(--color-primary);
            background-color: var(--color-surface);
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background-color: #e9eef2;
        }
        
        /* Status Indicator untuk top-bar */
        .status-indicator {
            margin-left: 15px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8em;
        }
        .status-loading { background-color: var(--color-yellow-accent); color: var(--color-text-dark); }
        .status-online { background-color: #00b894; color: var(--color-text-light); }
        .status-error { background-color: #d63031; color: var(--color-text-light); }

        h2 {
            font-size: 1.2rem; 
            font-weight: 700;
            margin-bottom: 10px; 
            color: var(--color-primary);
            text-align: center;
        }
            
        .panel {
            background-color: var(--color-surface);
            padding: 15px;
            border: 1px solid #edf2f7;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            flex-grow: 1;
        }

        /* Dashboard Grid Layout (50:50) */
        .dashboard {
            display: grid;
            grid-template-areas:  
                "summary table"
                "charts table"; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: auto 1fr; 
            gap: 5px 10px; 
            flex-grow: 1;
            padding-bottom: 0; 
        }
            
        /* Area-Area BARU */
        .summary-area { grid-area: summary; padding: 10px; } 
        .charts-area { 
            grid-area: charts; 
            padding: 10px; 
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px; 
            overflow-y: hidden; 
            margin-bottom: 0 !important; 
        } 
        .table-area { 
            grid-area: table; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            margin-bottom: 0 !important;
        }
        
        .summary-cards-wrapper { 
            display: flex;
            flex-direction: column;
            gap: 5px; 
        }

        .summary-cards-wrapper h2 {
            margin-bottom: 5px;
            text-align: left;
            padding-left: 5px;
            font-size: 1rem; 
        }

        .summary-cards {
            display: flex; 
            flex-wrap: nowrap;
            justify-content: space-between;
            gap: 5px; 
        }
            
        .summary-cards .card {
            width: calc(33.333% - 4px); 
            min-width: 90px; 
            padding: 8px 4px; 
            text-align: center;
            align-items: center;
            height: 70px; 
            justify-content: center; 
        }

        .summary-cards .card h3 {
            font-size: 0.65rem; 
            font-weight: 500;
            margin: 0 0 2px 0; 
            line-height: 1.1; 
            opacity: 0.9;
            text-align: center;
            white-space: normal; 
        }

        .summary-cards .card .value {
            font-size: 1.3rem; 
            font-weight: 700;
            margin: 1px 0;
            line-height: 1.1; 
            text-align: center;
            overflow: hidden; 
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .summary-cards .card .currency {
            font-size: 0.7rem;
            line-height: 1.1;
        }

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
            overflow-y: auto; 
        }

        .chart-card {
            padding: 8px;
            box-shadow: none; 
            border: none;
            background-color: transparent;
        }
        
        .charts-area .chart-card:nth-child(2) {
            flex-grow: 1; 
        }

        .chart-card h3 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .chart-container {
            position: relative;
            height: 170px; 
        }

        /* Style untuk Tabel */
        .table-area h2 {
            text-align: left;
            margin-bottom: 5px;
            padding: 0 5px;
        }

        .data-table-container {
            /* Batasi tinggi tabel agar hanya 13 baris terlihat */
            max-height: 560px; 
            overflow-y: auto;
            /* Hilangkan scroll horizontal pada container */
            overflow-x: hidden; 
            flex-grow: 1;
            padding-bottom: 0;
            border-radius: var(--border-radius);
            border: 1px solid #edf2f7; 
        }
        
        .table-area.panel {
            padding: 0; 
            border: none;
            box-shadow: none;
        }

        .data-table thead th {
            position: sticky;
            top: 0; 
            z-index: 15;
            padding: 8px 6px; 
            font-size: 0.75rem; 
            text-align: center;
            line-height: 1.1; 
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
            font-weight: 600;
            /* Hapus white-space: nowrap agar teks header wrap */
            white-space: normal; 
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: 1px solid #003a73; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-table th:first-child, .data-table td:first-child {
             text-align: center; 
        }
        
        .center-text {
            text-align: center !important;
        }
        
        .data-table td {
            padding: 4px 6px; 
            font-size: 0.8rem; 
            text-align: left;
            border-bottom: 1px solid #edf2f7;
            min-height: 35px; 
            height: 35px;
        }
            
        .data-table { 
            width: 100%;
            border-collapse: collapse;
            /* Pastikan layout tabel fixed untuk mencegah pelebaran kolom */
            table-layout: fixed; 
        }
        
        /* Lebar kolom spesifik */
        .data-table th:nth-child(1), .data-table td:nth-child(1) { width: 8%; } /* No. */
        .data-table th:nth-child(3), .data-table td:nth-child(3) { width: 15%; } /* Jumlah Proyek */
        .data-table th:nth-child(2), .data-table td:nth-child(2) { width: 77%; } /* Nama Instansi (Sisa Lebar) */

        
        .card {
            background-color: var(--color-surface);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            text-align: center;
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1; 
        }
        
        .card.total-projects { background: linear-gradient(135deg, var(--color-green), #20c997); }
        .card.total-value { background: linear-gradient(135deg, var(--color-primary), #0056b3); }
        .card.avg-value { background: linear-gradient(135deg, var(--color-secondary), #0052cc); }
        .card.total-tenaga-kerja { 
            background: linear-gradient(135deg, #dc3545, #c82333); 
            color: var(--color-text-light);
        }
        
        .data-table tr:nth-child(even) { background-color: #f8fafc; }
        .instansi-link { color: var(--color-secondary); font-weight: 500; text-decoration: none; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* Progress bar untuk loading data besar */
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background-color: var(--color-primary);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }


        .table-toolbar{display:flex;gap:8px;align-items:center;margin:8px 0 12px}
        .table-toolbar input[type="search"]{flex:1;padding:10px 12px;border:1px solid #ddd;border-radius:10px;font:inherit}
        .table-toolbar button{padding:8px 12px;border:1px solid #ddd;background:#f8f8f8;border-radius:10px;cursor:pointer}
        .table-toolbar button:hover{background:#eee}
        .highlight{background:linear-gradient(transparent 60%, #fff59d 60%)}
        .no-data-row td{color:#999}



        
        /* ================== STYLE UNTUK FOOTER BARU ================== */
        .main-footer {
            background: linear-gradient(135deg, var(--color-green), #20c997); /* Gradasi Hijau */
            color: var(--color-text-light);
            padding: 8px 15px; /* Padding lebih kecil, sesuai top-bar */
            font-size: 0.9em; /* Ukuran font lebih kecil */
            text-align: right; /* Rata kanan */
            margin-top: 10px; /* Jarak dari konten di atasnya */
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow); /* Shadow konsisten */
            font-weight: 500; /* Tidak terlalu tebal */
        }
        
        .footer-text {
            /* Tidak perlu div khusus, langsung di p */
            margin: 0; /* Hapus margin default p */
            line-height: 1.4;
        }

        /* ================== Media Queries untuk Responsif ================== */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-areas:  
                    "summary"
                    "charts"
                    "table"; 
                grid-template-columns: 1fr; 
                grid-template-rows: auto auto 1fr; 
                height: auto;
            }
            
            .container {
                padding: 8px;
            }
            
            header {
                flex-direction: column;
                gap: 8px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 6px;
                padding: 6px 10px;
            }
            
            .summary-cards {
                flex-wrap: wrap;
            }
            
            .summary-cards .card {
                width: calc(50% - 3px);
                margin-bottom: 5px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .main-footer {
                padding: 6px 10px; /* Padding lebih kecil lagi untuk mobile */
                font-size: 0.75rem; /* Ukuran font lebih kecil */
                text-align: center; /* Rata tengah di mobile */
            }
        }

        @media (max-width: 520px) {
            .summary-cards .card {
                width: 100%;
            }
            
            .header-title h1 {
                font-size: 0.9rem;
            }
            
            .header-title p {
                font-size: 0.7rem;
            }
            
            .header-logo {
                height: 50px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-section">
                <img src="medan.png" alt="Logo Kota Medan" class="header-logo">
                <img src="pemprovsu.png" alt="Logo Pemprovsu" class="header-logo">
            </div>
            <div class="header-title">
                <h1>Data Pemberi Kerja/Badan Usaha</h1>
                <h1>Kantor Cabang Medan Kota</h1>
                <p>(Data Perusahaan Peserta BPJS Ketenagakerjaan)</p>
            </div>

            <div class="header-section">
                <img src="logo.png" alt="Logo BPJS Ketenagakerjaan" class="header-logo">     
            </div>
        </header>
        
        <div class="top-bar">
            <div class="top-bar-left">
                <span id="currentDate"></span>
                <span class="status-indicator status-loading" id="connectionStatus">Memuat...</span>
            </div>
            <div class="top-bar-nav">
                <a href="index.html" class="nav-button">Home</a>
                <a href="topworst.html" class="nav-button">Top & Worst</a>
            </div>
            <div class="top-bar-right" style="display: flex; align-items: center;">
                <img src="semua.png" alt="Medan" class="header-person" style="margin-left: 5px;">
            </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="panel summary-area summary-cards-wrapper">
                <h2>Rekap Perusahaan</h2> 
                <div class="summary-cards">
                    <div class="card total-projects">
                        <h3>Total Perusahaan</h3>
                        <div class="value" id="totalCompanies">0</div>
                    </div>
                    <!-- <div class="card total-value">
                        <h3>Total Iuran</h3>
                        <div class="value currency" id="totalIuran">Rp 0</div>
                    </div> -->
                    <div class="card total-tenaga-kerja">
                        <h3>Total Tenaga Kerja</h3>
                        <div class="value" id="totalTenagaKerja">0</div>
                    </div>
                </div>
            </div>

            <div class="panel charts-area charts-container">
                <div class="chart-card">
                    <h3>Distribusi Perusahaan Berdasarkan Skala</h3>
                    <div class="chart-container">
                        <canvas id="skalaChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <h3>Distribusi Perusahaan Berdasarkan Program</h3>
                    <div class="chart-container">
                        <canvas id="programChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="panel table-area">
                <h2>Kecamatan</h2>
                <div class="table-toolbar">
                    <input type="search" id="tableSearch" placeholder="Cari NamaKecamatan" aria-label="Cari di tabel">
                    <button type="button" id="clearSearch" aria-label="Bersihkan">×</button>
                </div>
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div class="data-table-container"> 
                    <table class="data-table" id="mainDataTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Kecamatan</th>
                                <th class="center-text">Jumlah<br>Perusahaan</th>
                                <th class="center-text">Total<br>Iuran</th>
                            </tr>
                        </thead>
                        <tbody id="mainTableBody">
                            <tr>
                                <td colspan="4" style="text-align:center;padding:20px;color:#666;">
                                    <div class="loading-spinner"></div>
                                    <p style="margin-top:10px;">Memuat data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <footer class="main-footer">
        <p class="footer-text">BPJS Ketenagakerjaan Kantor Cabang Medan Kota</p>
    </footer>
    </div>
    

    <script>

        (function(){
            const input = document.getElementById('tableSearch');
            const clearBtn = document.getElementById('clearSearch');
            const tbody = document.getElementById('mainTableBody');
            if(!input || !tbody) return;

            const debounce = (fn, d=150)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; };

            function escapeHtml(s){
                s = (s == null) ? '' : String(s);
                return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
            }
            function highlight(text, q){
                const base = (text == null) ? '' : String(text);
                if(!q) return escapeHtml(base);
                const i = base.toLowerCase().indexOf(q.toLowerCase());
                if(i === -1) return escapeHtml(base);
                return escapeHtml(base.slice(0,i))
                + '<span class="highlight">' + escapeHtml(base.slice(i, i+q.length)) + '</span>'
                + escapeHtml(base.slice(i+q.length));
            }

            function filter(){
                const q = (input.value || '').trim().toLowerCase();
                const rows = Array.from(tbody.querySelectorAll('tr'));

                // buang pesan "no data" kalau ada
                const empty = tbody.querySelector('.no-data-row');
                if(empty) empty.remove();

                let visibleIdx = 0;

                rows.forEach(tr=>{
                // lewati row spinner
                if(tr.querySelector('.loading-spinner')){
                    tr.style.display = q ? 'none' : '';
                    return;
                }

                const cellsText = Array.from(tr.cells).slice(1).map(td=>{
                    const a = td.querySelector && td.querySelector('a');
                    // pakai teks mentah dari anchor (data-orig) agar span highlight tidak mengganggu pencarian
                    return ((a && a.dataset && a.dataset.orig) ? a.dataset.orig : (td.textContent || '')).toLowerCase();
                }).join(' | ');

                const match = q === '' ? true : cellsText.includes(q);
                tr.style.display = match ? '' : 'none';

                const nameCell = tr.cells && tr.cells[1];

                if(match){
                    // nomor urut
                    const firstCell = tr.cells && tr.cells[0];
                    if(firstCell) firstCell.textContent = (++visibleIdx).toString();

                    // highlight aman tanpa merusak href di <a>
                    if(nameCell){
                    const a = nameCell.querySelector('a');
                    if(a){
                        if(!a.dataset.orig) a.dataset.orig = a.textContent || '';
                        a.innerHTML = highlight(a.dataset.orig, q);
                    }else{
                        nameCell.innerHTML = highlight(nameCell.textContent || '', q);
                    }
                    }
                }else{
                    // bersihkan highlight di baris yang disembunyikan
                    if(nameCell){
                    const a = nameCell.querySelector('a');
                    if(a){
                        if(a.dataset.orig) a.textContent = a.dataset.orig;
                    }else{
                        nameCell.textContent = nameCell.textContent || '';
                    }
                    }
                }
                });

                if(visibleIdx === 0 && !tbody.querySelector('.loading-spinner')){
                const tr = document.createElement('tr');
                tr.className = 'no-data-row';
                tr.innerHTML = '<td colspan="4" style="text-align:center;padding:16px;">Tidak ada data yang cocok.</td>';
                tbody.appendChild(tr);
                }

                // kalau query kosong, bersihkan semua highlight
                if(!q){
                rows.forEach(tr=>{
                    const nameCell = tr.cells && tr.cells[1];
                    if(!nameCell) return;
                    const a = nameCell.querySelector('a');
                    if(a){
                    if(a.dataset.orig) a.textContent = a.dataset.orig;
                    }else{
                    nameCell.textContent = nameCell.textContent || '';
                    }
                });
                }
            }

            input.addEventListener('input', debounce(filter, 100));
            if(clearBtn){
                clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); filter(); });
            }

            // re-run filter saat tbody di-update (data async)
            const observer = new MutationObserver(debounce(filter, 0));
            observer.observe(tbody, { childList: true });

            })();

        let skalaChart = null;
        let programChart = null;
        let allData = [];

        // Configuration for Google Sheets API
        const SHEET_CONFIG = {
            sheetId: "1bi7beUHCGem8U7-huUarJY1V1pfTPLqSCRwghMjAehk",
            apiKey: "AIzaSyDDChj-Syqytv2HboLnbflQu7-u_5VAYIE",
            range: "Sheet1!A1:N11000" // Range untuk 11.000 data
        };

        

        

        document.addEventListener('DOMContentLoaded', async () => {
            updateCurrentDate();
            updateConnectionStatus('loading', 'Memuat data...');
            
            try {
                // Tampilkan progress bar
                document.getElementById('progressContainer').style.display = 'block';
                
                // Load data dari Google Sheets
                await loadAllData();
                
                if (allData && allData.length > 0) {
                    updateDashboard(allData);
                    updateConnectionStatus('online', `${allData.length} data berhasil dimuat`);
                
                    // Store data untuk penggunaan offline
                    try {
                        const dataToStore = JSON.stringify(allData);
                        if (typeof(Storage) !== "undefined") {
                            sessionStorage.setItem('companyData', dataToStore);
                        }
                    } catch (e) {
                        console.log("Note: Tidak dapat menyimpan data di session storage");
                    }
                } else {
                    console.log("⚠️ Tidak ada data ditemukan");
                    updateConnectionStatus('error', 'Tidak ada data');
                }
                
                // Sembunyikan progress bar
                document.getElementById('progressContainer').style.display = 'none';
            } catch (error) {
                console.error("❌ Error loading data:", error);
                updateConnectionStatus('error', 'Error memuat data');
                showError("Gagal memuat data dari Google Sheets. Silakan coba lagi.");
                
                // Sembunyikan progress bar
                document.getElementById('progressContainer').style.display = 'none';
            }
            
            // Tambahkan tombol refresh
            addRefreshButton();
        });

        async function loadAllData() {
            // Update progress bar
            updateProgressBar(10, 'Mengambil data dari Google Sheets...');
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.sheetId}/values/${SHEET_CONFIG.range}?key=${SHEET_CONFIG.apiKey}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                updateProgressBar(50, 'Memproses data...');
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('Tidak ada data ditemukan di spreadsheet');
                }
                
                // Ambil header (baris pertama)
                const headers = data.values[0];
                
                // Proses data (mulai dari baris kedua)
                allData = data.values.slice(1).map((row, index) => {
                    const company = {};
                    
                    // Mapping kolom berdasarkan header
                    headers.forEach((header, i) => {
                        // Normalisasi nama header
                        const normalizedHeader = header.toLowerCase().trim();
                        const cellValue = row[i] || '';
                        
                        if (normalizedHeader.includes('nama') && normalizedHeader.includes('perusahaan')) {
                            company.namaPerusahaan = cellValue;
                        } else if (normalizedHeader.includes('alamat')) {
                            company.alamat = cellValue;
                            company.kecamatan = extractKecamatanFromAlamat(cellValue);
                        } else if (normalizedHeader.includes('kecamatan')) {
                            company.kecamatan = cellValue;
                        } else if (normalizedHeader.includes('skala') || normalizedHeader.includes('usaha')) {
                            company.skalaUsaha = cellValue;
                        } else if (normalizedHeader.includes('prog') || normalizedHeader.includes('program')) {
                            company.program = cellValue;
                        } else if (normalizedHeader.includes('tk') || normalizedHeader.includes('aktif') || 
                                   normalizedHeader.includes('tenaga') || normalizedHeader.includes('kerja')) {
                            // Menangani berbagai kemungkinan nama kolom untuk tenaga kerja
                            let tkValue = cellValue;
                            if (typeof tkValue === 'string') {
                                tkValue = parseInt(tkValue.replace(/[^\d]/g, '')) || 0;
                            } else {
                                tkValue = parseInt(tkValue) || 0;
                            }
                            
                            company.tkAktif = tkValue;
                        } else if (normalizedHeader.includes('total') && normalizedHeader.includes('iuran')) {
                            // Parsing khusus untuk total iuran
                            let iuranValue = cellValue;
                            
                            // Jika string, bersihkan dan konversi
                            if (typeof iuranValue === 'string') {
                                iuranValue = iuranValue.replace(/[^\d,.-]/g, '');
                                
                                // Handle berbagai format angka
                                if (iuranValue.includes(',') && iuranValue.includes('.')) {
                                    iuranValue = iuranValue.replace(/\./g, '').replace(',', '.');
                                } else if (iuranValue.includes(',')) {
                                    iuranValue = iuranValue.replace(/,/g, '');
                                }
                                
                                company.nilaiPosting = parseFloat(iuranValue) || 0;
                            } else {
                                company.nilaiPosting = parseFloat(iuranValue) || 0;
                            }
                        } else if (normalizedHeader.includes('nilai') && normalizedHeader.includes('posting')) {
                            let postingValue = cellValue;
                            
                            if (typeof postingValue === 'string') {
                                postingValue = postingValue.replace(/[^\d,.-]/g, '');
                                
                                if (postingValue.includes(',') && postingValue.includes('.')) {
                                    postingValue = postingValue.replace(/\./g, '').replace(',', '.');
                                } else if (postingValue.includes(',')) {
                                    postingValue = postingValue.replace(/,/g, '');
                                }
                                
                                company.nilaiPosting = parseFloat(postingValue) || 0;
                            } else {
                                company.nilaiPosting = parseFloat(postingValue) || 0;
                            }
                        }
                    });
                    
                    if (!company.kecamatan) {
                        company.kecamatan = extractKecamatanFromAlamat(company.alamat);
                    }
                    
                    return company;
                });
                
                updateProgressBar(100, 'Data berhasil dimuat!');
                console.log(`✅ Data loaded: ${allData.length} records`);
                return allData;
                
            } catch (error) {
                console.error('Error fetching data from Google Sheets:', error);
                updateConnectionStatus('error', 'Gagal memuat data');
                showError("Gagal memuat data dari Google Sheets. Silakan periksa koneksi internet atau coba lagi nanti.");
                
                // Tidak menggunakan data sampel, tampilkan pesan error
                allData = [];
                updateProgressBar(100, 'Gagal memuat data');
                return allData;
            }
        }   
        
        function extractKecamatanFromAlamat(alamat) {
            if (!alamat || typeof alamat !== 'string') return 'Lain-lain';
            
            const alamatLower = alamat.toLowerCase();
            
            // Daftar kecamatan di Medan
            const kecamatanList = [
                "medan amplas", "medan area", "medan barat", "medan baru", "medan belawan",
                "medan deli", "medan denai", "medan helvetia", "medan johor", "medan kota",
                "medan labuhan", "medan maimun", "medan marelan", "medan perjuangan", "medan petisah",
                "medan polonia", "medan selayang", "medan sunggal", "medan tembung", "medan timur",
                "medan tuntungan"
            ];
            
            // Cari kecamatan dalam alamat
            for (const kecamatan of kecamatanList) {
                if (alamatLower.includes(kecamatan.toLowerCase())) {
                    return capitalizeWords(kecamatan);
                }
            }
            
            // Fallback: cari dengan pattern lain
            const kecamatanMatch = alamatLower.match(/(medan\s+\w+)/i);
            if (kecamatanMatch) {
                const foundKecamatan = capitalizeWords(kecamatanMatch[1]);
                if (kecamatanList.includes(foundKecamatan.toLowerCase())) {
                    return foundKecamatan;
                }
            }
            
            return 'Lain-lain';
        }
        
        function capitalizeWords(str) {
            return str.replace(/\w\S*/g, function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        function updateProgressBar(percent, message) {
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}% - ${message}`;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function updateDashboard(data) {
            updateSummaryCards(data);
            updateCharts(data);
            updateMainTable(data);
        }

        function updateSummaryCards(data) {
            const totalCompanies = data.length;
            
            // Total Iuran dari nilaiPosting
            const totalIuran = data.reduce((sum, company) => {
                let nilaiPosting = company.nilaiPosting || 0;
                
                if (typeof nilaiPosting === 'string') {
                    nilaiPosting = nilaiPosting.replace(/[^\d,.-]/g, '');
                    
                    if (nilaiPosting.includes(',') && nilaiPosting.includes('.')) {
                        nilaiPosting = nilaiPosting.replace(/\./g, '').replace(',', '.');
                    } else if (nilaiPosting.includes(',')) {
                        nilaiPosting = nilaiPosting.replace(/,/g, '');
                    }
                    
                    nilaiPosting = parseFloat(nilaiPosting) || 0;
                }
                
                return sum + nilaiPosting;
            }, 0);

            // Perbaikan perhitungan total tenaga kerja
            const totalTenagaKerja = data.reduce((sum, company) => {
                let tkAktif = company.tkAktif || 0;
                
                // Pastikan tkAktif adalah number
                if (typeof tkAktif === 'string') {
                    // Hapus karakter non-digit dan konversi ke number
                    tkAktif = parseInt(tkAktif.replace(/[^\d]/g, '')) || 0;
                }
                
                // Pastikan nilai tidak negatif
                return sum + Math.max(0, tkAktif);
            }, 0);

            const elTotal = document.getElementById('totalCompanies');
            const elTotalIuran = document.getElementById('totalIuran');
            const elTotalTenagaKerja = document.getElementById('totalTenagaKerja');

            if (elTotal) elTotal.textContent = totalCompanies.toLocaleString('id-ID');
            if (elTotalIuran) elTotalIuran.textContent = formatCurrency(totalIuran);
            if (elTotalTenagaKerja) elTotalTenagaKerja.textContent = totalTenagaKerja.toLocaleString('id-ID');

            console.log(`📊 Summary Updated | Perusahaan:${totalCompanies} | Iuran:${formatCurrency(totalIuran)} | Tenaga Kerja:${totalTenagaKerja}`);
        }

        function updateCharts(data) {
            updateSkalaChart(data);
            updateProgramChart(data);
        }

            function updateSkalaChart(data) {
  const skalaCounts = {};

  data.forEach(company => {
    let skala = company.skalaUsaha || 'Tidak Diketahui';
    // satukan MI → Mi (Mikro)
    if (skala === 'MI') skala = 'Mi';
    skalaCounts[skala] = (skalaCounts[skala] || 0) + 1;
  });

  // Kode → Nama
  const skalaNames = {
    'Mi': 'Mikro',
    'K':  'Kecil',
    'Mn': 'Menengah',
    'B':  'Besar',
    'Tidak Diketahui': 'Tidak Diketahui'
  };

  // URUTAN YANG DIINGINKAN (Mikro dulu)
  const ORDER = ['Mi', 'K', 'Mn', 'B', 'Tidak Diketahui'];

  // susun label & nilai mengikuti ORDER (termasuk 0 kalau tidak ada)
  const labels = ORDER.map(k => skalaNames[k]);
  const values = ORDER.map(k => skalaCounts[k] || 0);

  const colors = ['#004c99', '#0066cc', '#28a745', '#ffcc00', '#6c757d'];

  if (skalaChart) skalaChart.destroy();

  const ctx = document.getElementById('skalaChart').getContext('2d');
  skalaChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        label: 'Jumlah Perusahaan',
        data: values,
        backgroundColor: colors,
        borderColor: '#ffffff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const value = Number(ctx.raw) || 0;
              const total = ctx.dataset.data.reduce((a,b)=>a+Number(b||0),0);
              const pct = total ? (value/total*100) : 0;
              return `${ctx.label}: ${value.toLocaleString('id-ID')} perusahaan (${pct.toFixed(1)}%)`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { callback: v => v.toLocaleString('id-ID') }
        }
      }
    }
  });
}


        function updateProgramChart(data) {
            const programCounts = {};

            // Normalisasi program
            data.forEach(company => {
                let program = company.program || 'Tidak Diketahui';
                if (program === 'Tidak Diketahui') program = 'JKK & JKM'; // seperti keinginanmu
                programCounts[program] = (programCounts[program] || 0) + 1;
            });

            // Nama tampilannya
            const programNames = {
                'JKK & JKM': 'JKK & JKM',
                '3P'       : 'JKK, JKM & JHT',
                '4P'       : 'JKK, JKM, JHT & JP'
            };

            // Urutan yang diinginkan
            const desiredOrder = ['JKK & JKM', '3P', '4P'];

            // Susun label sesuai urutan; sisa kategori (jika ada) di-append di belakang
            const allKeys = Object.keys(programCounts);
            const orderedKeys = [
                ...desiredOrder.filter(k => allKeys.includes(k)),
                ...allKeys.filter(k => !desiredOrder.includes(k)).sort() // kategori lain (opsional)
            ];

            const labels = orderedKeys.map(k => programNames[k] || k);
            const values = orderedKeys.map(k => programCounts[k]);

            // Warna diselaraskan dengan urutan label
            const colorMap = {
                'JKK & JKM': '#004c99',
                '3P'       : '#0066cc',
                '4P'       : '#28a745'
            };
            const fallbackColors = ['#888888', '#aa66cc', '#ff9933', '#33cccc', '#9966ff'];
            const colors = orderedKeys.map((k, i) => colorMap[k] || fallbackColors[i % fallbackColors.length]);

            if (programChart) programChart.destroy();

            const ctx = document.getElementById('programChart').getContext('2d');
            programChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderColor: '#ffffff',
                    borderWidth: 2
                }]
                },
                options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                    callbacks: {
                        label: (ctx) => {
                        const value = Number(ctx.raw) || 0;
                        const total = ctx.dataset.data.reduce((a, b) => a + Number(b || 0), 0);
                        const pct = total ? (value / total * 100) : 0;
                        return `${ctx.label}: ${value.toLocaleString('id-ID')} perusahaan (${pct.toFixed(1)}%)`;
                        }
                    }
                    }
                }
                }
            });
            }


        function updateMainTable(data) {
            const kecamatanCounts = {};
            const kecamatanIuran = {};
            
            data.forEach(company => {
                const kecamatan = company.kecamatan || 'Luar Medan';
                kecamatanCounts[kecamatan] = (kecamatanCounts[kecamatan] || 0) + 1;
                
                // Total iuran dari nilaiPosting
                let nilaiPosting = company.nilaiPosting || 0;
                if (typeof nilaiPosting === 'string') {
                    nilaiPosting = parseFloat(nilaiPosting.replace(/[^\d,.-]/g, '')) || 0;
                }
                kecamatanIuran[kecamatan] = (kecamatanIuran[kecamatan] || 0) + nilaiPosting;
            });
            
            // Ensure all 21 kecamatan in Medan are included
            const kecamatanList = [
                "Medan Amplas", "Medan Area", "Medan Barat", "Medan Baru", "Medan Belawan",
                "Medan Deli", "Medan Denai", "Medan Helvetia", "Medan Johor", "Medan Kota",
                "Medan Labuhan", "Medan Maimun", "Medan Marelan", "Medan Perjuangan", "Medan Petisah",
                "Medan Polonia", "Medan Selayang", "Medan Sunggal", "Medan Tembung", "Medan Timur",
                "Medan Tuntungan", "Lain-lain"
            ];
            
            // Add any missing kecamatan with zero counts
            kecamatanList.forEach(kecamatan => {
                if (!kecamatanCounts[kecamatan]) {
                    kecamatanCounts[kecamatan] = 0;
                    kecamatanIuran[kecamatan] = 0;
                }
            });
            
            // Sort by count descending, but put "Lain-lain" at the end
            const sortedKecamatan = Object.keys(kecamatanCounts).sort((a, b) => {
                if (a === 'Lain-lain') return 1; // Selalu letakkan "Lain-lain" di akhir
                if (b === 'Lain-lain') return -1; // Selalu letakkan "Lain-lain" di akhir
                return kecamatanCounts[b] - kecamatanCounts[a]; // Urutkan berdasarkan jumlah perusahaan
            });
            
            const mainTableBody = document.getElementById('mainTableBody');
            mainTableBody.innerHTML = '';
            
            if (sortedKecamatan.length === 0) {
                mainTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:center;padding:20px;color:#666;">
                            <p>Tidak ada data yang tersedia</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            sortedKecamatan.forEach((kecamatan, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <a href="detail.html?kecamatan=${encodeURIComponent(kecamatan)}" class="instansi-link">
                            ${kecamatan}
                        </a>
                    </td>
                    <td class="center-text">${kecamatanCounts[kecamatan].toLocaleString('id-ID')}</td>
                    <td class="center-text">${formatCurrency(kecamatanIuran[kecamatan])}</td>
                `;
                mainTableBody.appendChild(row);
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            
            // Menggunakan Intl.DateTimeFormat untuk memastikan format yang konsisten
            const formatter = new Intl.DateTimeFormat('id-ID', {
                day: '2-digit', 
                month: 'short', // 'Oct', 'Sep', dll.
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hourCycle: 'h23',
                timeZone: 'Asia/Jakarta'
            });
            
            // Format mentah: "06 Okt 2025 10.23.56"
            let formatted = formatter.format(now);
            
            // Konversi nama bulan ID ke Inggris singkat (Okt -> Oct) dan ganti pemisah waktu
            formatted = formatted
                .replace('Okt', 'Oct') // Oktober ke Oct
                .replace('Sep', 'Sep') // September ke Sep
                .replace('Agu', 'Aug') // Agustus ke Aug
                .replace('Jul', 'Jul') // Juli ke Jul
                .replace('Jun', 'Jun') // Juni ke Jun
                .replace('Mei', 'May') // Mei ke May
                .replace('Apr', 'Apr') // April ke Apr
                .replace('Mar', 'Mar') // Maret ke Mar
                .replace('Feb', 'Feb') // Februari ke Feb
                .replace('Jan', 'Jan') // Januari ke Jan
                .replace(/\./g, ':') // Mengganti titik pemisah jam (jika ada)
                .replace(/\s\s+/g, ' '); // Menghilangkan spasi ganda

            const finalString = `Update data per tgl. ${formatted}`;
            
            const dateElement = document.getElementById('currentDate');
            if (dateElement) {
                dateElement.textContent = finalString;
            }
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = message;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px; border-radius: 8px; z-index: 10000; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <strong>Error:</strong> ${message}
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: 10px;">&times;</button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function addRefreshButton() {
            const topBarRight = document.querySelector('.top-bar-right');
            if (topBarRight) {
                const refreshButton = document.createElement('button');
                refreshButton.innerHTML = '🔄 Refresh';
                refreshButton.className = 'nav-button';
                refreshButton.style.cssText = `
                    background: var(--color-surface);
                    color: var(--color-primary);
                    border: none;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    margin-left: 10px;
                `;
                refreshButton.onclick = refreshData;
                refreshButton.onmouseover = function() {
                    this.style.background = '#e9eef2';
                    this.style.transform = 'translateY(-1px)';
                };
                refreshButton.onmouseout = function() {
                    this.style.background = 'var(--color-surface)';
                    this.style.transform = 'translateY(0)';
                };
                topBarRight.appendChild(refreshButton);
            }
        }

        // Function to manually refresh data
        function refreshData() {
            updateConnectionStatus('loading', 'Memuat ulang...');
            
            // Tampilkan progress bar
            document.getElementById('progressContainer').style.display = 'block';
            
            loadAllData()
                .then(data => {
                    if (data && data.length > 0) {
                        updateDashboard(data);
                        updateConnectionStatus('online', `${data.length} data berhasil dimuat`);
                        console.log(`✅ Data refreshed successfully: ${data.length} records`);
                        
                        // Show success message briefly
                        const successDiv = document.createElement('div');
                        successDiv.innerHTML = `
                            <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                ✅ Data berhasil diperbarui!
                            </div>
                        `;
                        document.body.appendChild(successDiv);
                        setTimeout(() => {
                            if (successDiv.parentElement) {
                                successDiv.remove();
                            }
                        }, 3000);
                    } else {
                        updateConnectionStatus('error', 'Tidak ada data');
                    }
                    
                    // Sembunyikan progress bar
                    document.getElementById('progressContainer').style.display = 'none';
                })
                .catch(error => {
                    console.error("❌ Error refreshing data:", error);
                    updateConnectionStatus('error', 'Error memuat data');
                    showError("Gagal memperbarui data. Silakan coba lagi.");
                    
                    // Sembunyikan progress bar
                    document.getElementById('progressContainer').style.display = 'none';
                });
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            console.log("🔄 Auto-refreshing data...");
            refreshData();
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
