<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pemberi Kerja/Badan Usaha Kantor Cabang Medan Kota</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* [Semua CSS styles tetap sama seperti sebelumnya] */
        :root {
            --color-primary: #004c99;
            --color-secondary: #0066cc;
            --color-green: #28a745;
            --color-yellow-accent: #ffc107;
            --color-background: #f0f3f6;
            --color-surface: #ffffff;
            --color-text-dark: #333333;
            --color-text-light: #ffffff;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            --border-radius: 8px;
            --font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-dark);
            min-height: 100vh;
            padding: 10px;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            flex-grow: 1;
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--color-surface);
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .header-section {
            display: flex;
            align-items: center;
        }

        .header-logo {
            height: 70px;
            margin-right: 8px;
            border-radius: 6px;
        }
            
        .header-logo:last-of-type {
            margin-right: 0;
        }

        .header-title {
            text-align: center;
            flex-grow: 1;
        }
            
        .header-title h1 {
            font-size: 1.1rem;
            color: var(--color-primary);
            font-weight: 700;
            margin-bottom: 3px;
        }
            
        .header-title p {
            font-size: 0.8rem;
            font-weight: 500;
            color: #000000;
            font-style: italic;
        }

        .header-person {
            height: 35px;
            margin-left: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--color-green), #20c997);
            color: var(--color-text-light);
            padding: 8px 15px;
            margin-bottom: 5px;
            font-weight: 500;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-size: 1em;
        }
            
        .top-bar-left {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .top-bar-nav {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }

        .nav-button {
            display: inline-block;
            margin: 0 5px;
            padding: 6px 15px;
            font-size: 0.9em;
            color: var(--color-primary);
            background-color: var(--color-surface);
            border-radius: 6px;
            text-decoration: none;
            font-weight: bold;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background-color: #e9eef2;
        }
        
        .status-indicator {
            margin-left: 15px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8em;
        }
        .status-loading { background-color: var(--color-yellow-accent); color: var(--color-text-dark); }
        .status-online { background-color: #00b894; color: var(--color-text-light); }
        .status-error { background-color: #d63031; color: var(--color-text-light); }

        h2 {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--color-primary);
            text-align: center;
        }
            
        .panel {
            background-color: var(--color-surface);
            padding: 15px;
            border: 1px solid #edf2f7;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            flex-grow: 1;
        }

        .dashboard {
            display: grid;
            grid-template-areas: 	
                "summary table"
                "charts table";
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr;
            gap: 5px 10px;
            flex-grow: 1;
            padding-bottom: 0;
        }
            
        .summary-area { grid-area: summary; padding: 10px; }
        .charts-area { 
            grid-area: charts; 
            padding: 10px; 
            height: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
            overflow-y: hidden;
            margin-bottom: 0 !important;
        } 
        .table-area { 
            grid-area: table; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
            padding: 10px; 
            margin-bottom: 0 !important;
        }
        
        .summary-cards-wrapper { 
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .summary-cards-wrapper h2 {
            margin-bottom: 5px;
            text-align: left;
            padding-left: 5px;
            font-size: 1rem;
        }

        .summary-cards {
            display: flex; 
            flex-wrap: nowrap;
            justify-content: space-between;
            gap: 5px;
        }
            
        .summary-cards .card {
            width: calc(33.333% - 4px);
            min-width: 90px;
            padding: 8px 4px;
            text-align: center;
            align-items: center;
            height: 70px;
            justify-content: center;
        }

        .summary-cards .card h3 {
            font-size: 0.65rem;
            font-weight: 500;
            margin: 0 0 2px 0;
            line-height: 1.1;
            opacity: 0.9;
            text-align: center;
            white-space: normal;
        }

        .summary-cards .card .value {
            font-size: 1.3rem;
            font-weight: 700;
            margin: 1px 0;
            line-height: 1.1;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .summary-cards .card .currency {
            font-size: 0.7rem;
            line-height: 1.1;
        }

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .chart-card {
            padding: 8px;
            box-shadow: none;
            border: none;
            background-color: transparent;
        }
        
        .charts-area .chart-card:nth-child(2) {
            flex-grow: 1;
        }

        .chart-card h3 {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .chart-container {
            position: relative;
            height: 170px;
        }

        .table-area h2 {
            text-align: left;
            margin-bottom: 5px;
            padding: 0 5px;
        }

        .data-table-container {
            max-height: 500px;
            overflow-y: auto;
            overflow-x: hidden;
            flex-grow: 1;
            padding-bottom: 0;
            border-radius: var(--border-radius);
            border: 1px solid #edf2f7;
        }
        
        .table-area.panel {
            padding: 0;
            border: none;
            box-shadow: none;
        }

        .data-table thead th {
            position: sticky;
            top: 0;
            z-index: 15;
            padding: 8px 6px;
            font-size: 0.75rem;
            text-align: center;
            line-height: 1.1;
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
            font-weight: 600;
            white-space: normal;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            border: 1px solid #003a73;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-table th:first-child, .data-table td:first-child {
             text-align: center;
        }
        
        .center-text {
            text-align: center !important;
        }
        
        .data-table td {
            padding: 4px 6px;
            font-size: 0.8rem;
            text-align: left;
            border-bottom: 1px solid #edf2f7;
            min-height: 35px;
            height: 35px;
        }
            
        .data-table { 
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        /* Lebar kolom untuk tabel perusahaan */
        .company-table th:nth-child(1), .company-table td:nth-child(1) { width: 8%; }
        .company-table th:nth-child(2), .company-table td:nth-child(2) { width: 60%; }
        .company-table th:nth-child(3), .company-table td:nth-child(3) { width: 20%; }
        .company-table th:nth-child(4), .company-table td:nth-child(4) { width: 12%; }
        
        /* Lebar kolom untuk tabel kecamatan */
        .kecamatan-table th:nth-child(1), .kecamatan-table td:nth-child(1) { width: 8%; }
        .kecamatan-table th:nth-child(2), .kecamatan-table td:nth-child(2) { width: 70%; }
        .kecamatan-table th:nth-child(3), .kecamatan-table td:nth-child(3) { width: 22%; }
        
        .card {
            background-color: var(--color-surface);
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            text-align: center;
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            flex-grow: 1;
        }
        
        .card.total-projects { background: linear-gradient(135deg, var(--color-green), #20c997); }
        .card.total-tenaga-kerja { 
            background: linear-gradient(135deg, #dc3545, #c82333); 
            color: var(--color-text-light);
        }
        
        .data-table tr:nth-child(even) { background-color: #f8fafc; }
        .instansi-link { color: var(--color-secondary); font-weight: 500; text-decoration: none; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background-color: var(--color-primary);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .table-toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            margin: 8px 0 12px;
        }

        .search-container {
            display: flex;
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .search-type-select {
            padding: 10px 12px;
            border: none;
            border-right: 1px solid #ddd;
            background: #f8f8f8;
            font: inherit;
            cursor: pointer;
            min-width: 140px;
        }

        .search-input {
            flex: 1;
            padding: 10px 12px;
            border: none;
            font: inherit;
        }

        .search-input:focus {
            outline: none;
        }

        .clear-search-btn {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: #f8f8f8;
            border-radius: 10px;
            cursor: pointer;
        }

        .clear-search-btn:hover {
            background: #eee;
        }

        .highlight {
            background: linear-gradient(transparent 60%, #fff59d 60%);
        }

        .no-data-row td {
            color: #999;
        }

        /* STYLE UNTUK DROPDOWN TABEL */
        .table-selector {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            position: relative;
        }

        .table-selector h2 {
            margin: 0;
            margin-right: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .dropdown-arrow {
            margin-left: 5px;
            transition: transform 0.3s ease;
        }

        .table-selector.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .table-options {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 100;
            display: none;
            min-width: 200px;
        }

        .table-selector.active .table-options {
            display: block;
        }

        .table-option {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .table-option:hover {
            background-color: #f5f5f5;
        }

        .table-option:last-child {
            border-bottom: none;
        }

        /* PAGINATION STYLES */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            gap: 5px;
            padding: 5px 0; 
        }

        .pagination button {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: #f0f0f0;
            border-color: var(--color-primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .pagination button#prevPage, .pagination button#nextPage {
            font-weight: bold;
        }

        .pagination-info {
            font-size: 0.8rem;
            margin: 0 10px;
            font-weight: 500;
            color: var(--color-text-dark);
        }
        
        /* ================== STYLE UNTUK FOOTER ================== */
        .main-footer {
            background: linear-gradient(135deg, var(--color-green), #20c997);
            color: var(--color-text-light);
            padding: 8px 15px;
            font-size: 0.9em;
            text-align: right;
            margin-top: 10px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            font-weight: 500;
        }
        
        .footer-text {
            margin: 0;
            line-height: 1.4;
        }

        /* ================== Media Queries untuk Responsif ================== */
        @media (max-width: 900px) {
            .dashboard {
                grid-template-areas: 	
                    "summary"
                    "charts"
                    "table";
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr;
                height: auto;
            }
            
            .container {
                padding: 8px;
            }
            
            header {
                flex-direction: column;
                gap: 8px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 6px;
                padding: 6px 10px;
            }
            
            .summary-cards {
                flex-wrap: wrap;
            }
            
            .summary-cards .card {
                width: calc(50% - 3px);
                margin-bottom: 5px;
            }
            
            .chart-container {
                height: 200px;
            }
            
            .search-container {
                flex-direction: column;
                border-radius: 10px;
            }
            
            .search-type-select {
                border-right: none;
                border-bottom: 1px solid #ddd;
                min-width: 100%;
            }
            
            .main-footer {
                padding: 6px 10px;
                font-size: 0.75rem;
                text-align: center;
            }
        }

        @media (max-width: 520px) {
            .summary-cards .card {
                width: 100%;
            }
            
            .header-title h1 {
                font-size: 0.9rem;
            }
            
            .header-title p {
                font-size: 0.7rem;
            }
            
            .header-logo {
                height: 50px;
            }


            /* Style untuk heading dalam bulatan biru */
.circle-heading {
    display: inline-block;
    background: linear-gradient(135deg, var(--color-primary), #0056b3);
    color: var(--color-text-light);
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    text-align: center;
    box-shadow: var(--box-shadow);
    margin-bottom: 10px;
}

.summary-cards-wrapper h2.circle-heading {
    text-align: left;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.chart-card h3.circle-heading {
    margin-bottom: 8px;
    font-size: 0.85rem;
    text-align: center;
}
        }
        
        .circle-heading-container {
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 10px;
            display: inline-block;
            text-align: center; /* Center the text */
        }
        
         .circle-heading {
            display: inline; /* Make the heading inline */
            margin: 0; /* Remove default margins */
        }
        
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-section">
                <img src="medan.png" alt="Logo Kota Medan" class="header-logo">
                <img src="pemprovsu.png" alt="Logo Pemprovsu" class="header-logo">
            </div>
            <div class="header-title">
                <h1>Data Pemberi Kerja/Badan Usaha</h1>
                <h1>Kantor Cabang Medan Kota</h1>
                <p>(Data Perusahaan Peserta BPJS Ketenagakerjaan)</p>
            </div>

            <div class="header-section">
                <img src="logo.png" alt="Logo BPJS Ketenagakerjaan" class="header-logo"> 	
            </div>
        </header>
        
        <div class="top-bar">
            <div class="top-bar-left">
                <span id="currentDate"></span>
                <span class="status-indicator status-loading" id="connectionStatus">Memuat...</span>
            </div>
            <div class="top-bar-nav">
                <a href="index.html" class="nav-button">Home</a>
                <a href="topworst.html" class="nav-button">Top & Worst</a>
            </div>
            <div class="top-bar-right" style="display: flex; align-items: center;">
                <img src="semua.png" alt="Medan" class="header-person" style="margin-left: 5px;">
            </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="panel summary-area summary-cards-wrapper">
                 <div class="circle-heading-container">Rekap Perusahaan</div> 
                <div class="summary-cards">
                    <div class="card total-projects">
                        <h3>Total Perusahaan</h3>
                        <div class="value" id="totalCompanies">0</div>
                    </div>
                    <div class="card total-tenaga-kerja">
                        <h3>Total Tenaga Kerja</h3>
                        <div class="value" id="totalTenagaKerja">0</div>
                    </div>
                </div>
            </div>

            <div class="panel charts-area charts-container">
    <div class="chart-card">
        <div class="circle-heading-container">Distribusi Perusahaan Berdasarkan Skala</div>
        <div class="chart-container">
            <canvas id="skalaChart"></canvas>
        </div>
    </div>
    <div class="chart-card">
        <div class="circle-heading-container">Distribusi Perusahaan Berdasarkan Program</div>
        <div class="chart-container">
            <canvas id="programChart"></canvas>
        </div>
    </div>
</div>

            <div class="panel table-area">
                <div class="table-selector" id="tableSelector">
                    <div class="circle-heading-container" id="tableTitle">Kecamatan <span class="dropdown-arrow">▼</span></div>
                    <div class="table-options">
                        <div class="table-option" data-table="kecamatan">Kecamatan</div>
                        <div class="table-option" data-table="perusahaan">Perusahaan</div>
                    </div>
                </div>
                
                <div class="table-toolbar">
                    <div class="search-container">
                        <select class="search-type-select" id="searchType">
                            <option value="kecamatan">Cari Kecamatan</option>
                            <option value="perusahaan">Cari Perusahaan</option>
                        </select>
                        <input type="search" class="search-input" id="tableSearch" placeholder="Masukkan kata kunci..." aria-label="Cari di tabel">
                    </div>
                    <button type="button" class="clear-search-btn" id="clearSearch" aria-label="Bersihkan pencarian">×</button>
                </div>
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                
                <div class="data-table-container" id="kecamatanTableContainer"> 
                    <table class="data-table kecamatan-table" id="kecamatanTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Kecamatan</th>
                                <th class="center-text">Jumlah<br>Perusahaan</th>
                            </tr>
                        </thead>
                        <tbody id="kecamatanTableBody">
                            <tr>
                                <td colspan="3" style="text-align:center;padding:20px;color:#666;">
                                    <div class="loading-spinner"></div>
                                    <p style="margin-top:10px;">Memuat data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="data-table-container" id="perusahaanTableContainer" style="display: none;"> 
                    <table class="data-table company-table" id="perusahaanTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Perusahaan</th>
                                <th>Kecamatan</th>
                                <th class="center-text">Tenaga<br>Kerja</th>
                            </tr>
                        </thead>
                        <tbody id="perusahaanTableBody">
                            <tr>
                                <td colspan="4" style="text-align:center;padding:20px;color:#666;">
                                    <div class="loading-spinner"></div>
                                    <p style="margin-top:10px;">Memuat data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="perusahaanPagination" style="display: none;">
                    <button id="prevPage" disabled>Sebelumnya</button>
                    <span class="pagination-info" id="pageInfo">Halaman 1 dari 1</span>
                    <button id="nextPage" disabled>Selanjutnya</button>
                </div>
            </div>
        </div>
        <footer class="main-footer">
            <p class="footer-text">BPJS Ketenagakerjaan Kantor Cabang Medan Kota</p>
        </footer>
    </div>
    

    <script>
        // ==========================================================
        // DEKLARASI VARIABEL GLOBAL UNTUK AKSES DATA YANG KONSISTEN
        // ==========================================================
        let skalaChart = null;
        let programChart = null;
        let allData = []; // Data mentah dari sheet
        let filteredCompanyData = []; // Data yang sudah difilter/dipaginasi
        let currentPage = 1;
        const rowsPerPage = 15; // Jumlah baris per halaman

        // Configuration for Google Sheets API
        const SHEET_CONFIG = {
            sheetId: "1bi7beUHCGem8U7-huUarJY1V1pfTPLqSCRwghMjAehk",
            apiKey: "AIzaSyDDChj-Syqytv2HboLnbflQu7-u_5VAYIE",
            range: "Sheet1!A1:N11000"
        };
        
        // ==========================================================
        // FUNGSI UTILITY (GLOBAL)
        // ==========================================================
        function escapeHtml(s){
            s = (s == null) ? '' : String(s);
            return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
        }
        
        function highlight(text, q){
            const base = (text == null) ? '' : String(text);
            if(!q) return escapeHtml(base);
            const i = base.toLowerCase().indexOf(q.toLowerCase());
            if(i === -1) return escapeHtml(base);
            return escapeHtml(base.slice(0,i))
            + '<span class="highlight">' + escapeHtml(base.slice(i, i+q.length)) + '</span>'
            + escapeHtml(base.slice(i+q.length));
        }

        function capitalizeWords(str) {
    return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
}
        
        function debounce(fn, d=150){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); }; }

        // ==========================================================
        // FUNGSI PAGINASI & FILTER PERUSAHAAN (GLOBAL)
        // ==========================================================
        function updatePerusahaanTablePage(q = '') {
            const perusahaanTableBody = document.getElementById('perusahaanTableBody');
            const perusahaanPagination = document.getElementById('perusahaanPagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            
            if (!perusahaanTableBody || filteredCompanyData.length === 0) {
                perusahaanTableBody.innerHTML = `
                    <tr class="no-data-row">
                        <td colspan="4" style="text-align:center;padding:20px;color:#666;">
                            <p>${filteredCompanyData.length === 0 ? 'Tidak ada data yang dimuat' : 'Tidak ada data yang cocok.'}</p>
                        </td>
                    </tr>
                `;
                if(perusahaanPagination) perusahaanPagination.style.display = 'none';
                return;
            }

            const totalRecords = filteredCompanyData.length;
            const totalPages = Math.ceil(totalRecords / rowsPerPage);
            
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, totalRecords);
            const pageData = filteredCompanyData.slice(startIndex, endIndex);
            
            perusahaanTableBody.innerHTML = '';
            
            pageData.forEach((company, index) => {
                const row = document.createElement('tr');
                
                const namaPerusahaan = company.namaPerusahaan || 'Nama tidak tersedia';
                const kecamatan = company.kecamatan || 'Lain-lain';
                const tenagaKerja = (company.tkAktif || 0).toLocaleString('id-ID');
                
                const highlightedName = highlight(namaPerusahaan, q);
                const highlightedKecamatan = highlight(kecamatan, q);
                
                row.innerHTML = `
                    <td>${startIndex + index + 1}</td>
                    <td><span data-orig="${escapeHtml(namaPerusahaan)}">${highlightedName}</span></td>
                    <td><span data-orig="${escapeHtml(kecamatan)}">${highlightedKecamatan}</span></td>
                    <td class="center-text">${tenagaKerja}</td>
                `;
                perusahaanTableBody.appendChild(row);
            });
            
            // Update pagination info dan status tombol
            pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            
            // Tampilkan pagination jika ada lebih dari satu halaman
            perusahaanPagination.style.display = totalPages > 1 ? 'flex' : 'none';
        }

        function filterPerusahaanTable(q) {
            if (q) {
                filteredCompanyData = allData.filter(company => {
                    const namaPerusahaan = (company.namaPerusahaan || '').toLowerCase();
                    const kecamatan = (company.kecamatan || '').toLowerCase();
                    return namaPerusahaan.includes(q) || kecamatan.includes(q);
                });
            } else {
                filteredCompanyData = [...allData];
            }
            
            currentPage = 1;
            updatePerusahaanTablePage(q); 
        }

        // ==========================================================
        // IIFE UNTUK FUNGSI INTERAKSI DOM DAN HANDLER
        // ==========================================================
        (function(){
            const input = document.getElementById('tableSearch');
            const clearBtn = document.getElementById('clearSearch');
            const searchType = document.getElementById('searchType');
            const kecamatanTableContainer = document.getElementById('kecamatanTableContainer');
            const perusahaanTableContainer = document.getElementById('perusahaanTableContainer');
            const tableTitle = document.getElementById('tableTitle');
            const kecamatanTableBody = document.getElementById('kecamatanTableBody');
            const tableSelector = document.getElementById('tableSelector');
            const tableOptions = document.querySelectorAll('.table-option');
            const perusahaanPagination = document.getElementById('perusahaanPagination');

            if(!input || !kecamatanTableBody) return;

            let activeTable = 'kecamatan';
            
            function filterKecamatanTable(q) {
                // Logika filter untuk tabel kecamatan (sama seperti sebelumnya, memfilter DOM)
                const empty = kecamatanTableBody.querySelector('.no-data-row');
                if(empty) empty.remove();

                const rows = Array.from(kecamatanTableBody.querySelectorAll('tr'));
                let visibleIdx = 0;

                rows.forEach(tr=>{
                    if(tr.querySelector('.loading-spinner')){
                        tr.style.display = q ? 'none' : '';
                        return;
                    }
                    const nameCell = tr.cells && tr.cells[1];
                    const textToSearch = (nameCell && nameCell.querySelector('a') ? nameCell.querySelector('a').dataset.orig : (tr.textContent || '')).toLowerCase();

                    const match = q === '' ? true : textToSearch.includes(q);
                    tr.style.display = match ? '' : 'none';

                    if(match){
                        const firstCell = tr.cells && tr.cells[0];
                        if(firstCell) firstCell.textContent = (++visibleIdx).toString();
                        if(nameCell){
                            const a = nameCell.querySelector('a');
                            if(a){
                                if(!a.dataset.orig) a.dataset.orig = a.textContent || '';
                                a.innerHTML = highlight(a.dataset.orig, q);
                            }
                        }
                    } else {
                        if(nameCell){
                            const a = nameCell.querySelector('a');
                            if(a && a.dataset.orig) a.textContent = a.dataset.orig;
                        }
                    }
                });

                if(visibleIdx === 0 && !kecamatanTableBody.querySelector('.loading-spinner')){
                    const tr = document.createElement('tr');
                    tr.className = 'no-data-row';
                    tr.innerHTML = '<td colspan="3" style="text-align:center;padding:16px;">Tidak ada data yang cocok.</td>';
                    kecamatanTableBody.appendChild(tr);
                }
            }
            
            function filter(){
                const q = (input.value || '').trim().toLowerCase();
                const searchTypeValue = searchType.value;

                input.placeholder = searchTypeValue === 'kecamatan' ? 
                                    'Cari Nama Kecamatan...' : 
                                    'Cari Nama Perusahaan atau Kecamatan...';

                if (activeTable === 'perusahaan') {
                    filterPerusahaanTable(q);
                } else {
                    filterKecamatanTable(q);
                }
            }

            function switchTable(tableName) {
                activeTable = tableName;
                
                kecamatanTableContainer.style.display = tableName === 'kecamatan' ? 'block' : 'none';
                perusahaanTableContainer.style.display = tableName === 'perusahaan' ? 'block' : 'none';
                perusahaanPagination.style.display = 'none';
                
                tableTitle.innerHTML = tableName === 'kecamatan' ? 'Kecamatan <span class="dropdown-arrow">▼</span>' : 'Perusahaan <span class="dropdown-arrow">▼</span>';
                
                searchType.value = tableName === 'kecamatan' ? 'kecamatan' : 'perusahaan';
                
                input.value = '';
                
                if (tableName === 'perusahaan') {
                    if (allData.length > 0) {
                        filteredCompanyData = [...allData]; 
                        currentPage = 1; 
                        updatePerusahaanTablePage();
                    }
                } else {
                    filterKecamatanTable('');
                }
                
                tableSelector.classList.remove('active');
            }

            // --- Event Listeners ---
            tableSelector.addEventListener('click', function() { this.classList.toggle('active'); });
            tableOptions.forEach(option => {
                option.addEventListener('click', function() {
                    switchTable(this.getAttribute('data-table'));
                });
            });

            // PERBAIKAN: Panggil fungsi global yang memperbarui currentPage
            document.getElementById('prevPage').addEventListener('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    updatePerusahaanTablePage(input.value.trim().toLowerCase());
                }
            });

            document.getElementById('nextPage').addEventListener('click', function() {
                const totalPages = Math.ceil(filteredCompanyData.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePerusahaanTablePage(input.value.trim().toLowerCase());
                }
            });

            input.addEventListener('input', debounce(filter, 100));
            searchType.addEventListener('change', filter);
            if(clearBtn){ clearBtn.addEventListener('click', ()=>{ input.value=''; input.focus(); filter(); }); }

        })();

        // ==========================================================
        // FUNGSI DATA DAN UTILITY (DI LUAR IIFE)
        // ==========================================================
        
      function extractKecamatanFromAlamat(alamat) {
    if (!alamat || typeof alamat !== 'string') return 'Lain-lain';
    
    const alamatLower = alamat.toLowerCase().trim();
    
    // Daftar lengkap kecamatan di Kota Medan
    const kecamatanList = [
        "medan amplas", "medan area", "medan barat", "medan baru", "medan belawan",
        "medan deli", "medan denai", "medan helvetia", "medan johor", "medan kota",
        "medan labuhan", "medan maimun", "medan marelan", "medan perjuangan", "medan petisah",
        "medan polonia", "medan selayang", "medan sunggal", "medan tembung", "medan timur",
        "medan tuntungan"
    ];
    
    // Cek kota/kabupaten untuk filter luar Medan - HARUS DI AKHIR ALAMAT
    const kotaLuarMedan = [
        "binjai kota", "pekanbaru", "jakarta", "deli serdang", "serdang bedagai", 
        "labuhan deli", "percut sei tuan", "kisaran", "pekan baru", "tangerang",
        "kelapa dua", "pancur batu"
    ];
    
    // PERTAMA: Cari pattern kecamatan Medan di mana saja dalam alamat
    const medanPatterns = [
        // Pattern 1: Format "KEC. MEDAN BARAT" (dengan titik atau tanpa)
        /kec\.?\s*(medan\s+\w+)/i,
        // Pattern 2: Format "KECAMATAN MEDAN BARAT" 
        /kecamatan\s+(medan\s+\w+)/i,
        // Pattern 3: Format "MEDAN TIMUR KOTA MEDAN" 
        /(medan\s+\w+)\s+kota\s+medan/i,
        // Pattern 4: Format "SUNGGAL KOTA MEDAN" atau "DENAI KOTA MEDAN"
        /(\w+)\s+kota\s+medan/i,
        // Pattern 5: Setelah "KEL." dengan format apapun
        /(?:kel\.?|kelurahan)\s+[^,]+\s+(medan\s+\w+)/i,
        // Pattern 6: "MEDAN BARAT" di mana saja (fallback)
        /(medan\s+\w+)/i
    ];
    
    // Cari kecamatan Medan terlebih dahulu
    let foundKecamatan = null;
    for (const pattern of medanPatterns) {
        const match = alamatLower.match(pattern);
        if (match) {
            console.log("Pattern matched:", pattern, "->", match[1] || match[0]);
            let tempKecamatan = capitalizeWords(match[1] || match[0]);
            
            // Handle kasus "SUNGGAL" menjadi "MEDAN SUNGGAL"
            if (!tempKecamatan.toLowerCase().startsWith('medan ') && 
                kecamatanList.includes('medan ' + tempKecamatan.toLowerCase())) {
                tempKecamatan = 'Medan ' + tempKecamatan;
            }
            
            // Handle typo
            tempKecamatan = tempKecamatan.replace('sunngal', 'sunggal');
            
            // Validasi apakah yang ditemukan benar kecamatan Medan
            if (kecamatanList.includes(tempKecamatan.toLowerCase())) {
                foundKecamatan = tempKecamatan;
                break;
            }
        }
    }
    
    // KEDUA: Jika ditemukan kecamatan Medan, cek apakah ada kontradiksi dengan kota luar
    if (foundKecamatan) {
        // Cek apakah ada kota luar Medan di AKHIR alamat (bukan di tengah)
        const hasKotaLuarDiAkhir = kotaLuarMedan.some(kota => {
            const regex = new RegExp(kota + '\\s*$', 'i');
            return regex.test(alamatLower);
        });
        
        // Jika ada kecamatan Medan dan TIDAK ada kota luar di akhir, return kecamatan Medan
        if (!hasKotaLuarDiAkhir) {
            return foundKecamatan;
        }
    }
    
    // KETIGA: Cek manual untuk kasus spesifik
    const manualChecks = [
        { test: ['gaharu', 'medan timur'], result: 'Medan Timur' },
        { test: ['cinta damai', 'medan helvetia'], result: 'Medan Helvetia' },
        { test: ['tanjung gusta', 'sunggal'], result: 'Medan Sunggal' },
        { test: ['sei sikambing', 'sei skambing', 'sikambing'], result: 'Medan Sunggal' },
        { test: ['kesawan'], result: 'Medan Barat' },
        { test: ['sei rengas', 'asia'], result: 'Medan Area' },
        { test: ['bangun purba', 'kebun'], result: 'Medan Area' },
        { test: ['mabar', 'medan deli'], result: 'Medan Deli' },
        { test: ['binjai', 'medan denai'], result: 'Medan Denai' },
        { test: ['pancing', 'medan estate', 'tembung'], result: 'Medan Tembung' },
        { test: ['william iskandar', 'medan tembung'], result: 'Medan Tembung' },
        { test: ['pulo brayan', 'brayan city', 'medan barat'], result: 'Medan Barat' }
    ];
    
    for (const check of manualChecks) {
        if (check.test.some(keyword => alamatLower.includes(keyword))) {
            return check.result;
        }
    }
    
    return 'Lain-lain';
}

// Fungsi helper untuk membersihkan dan memproses data
function processCompanyData(company) {
    if (!company.kecamatan && company.alamat) {
        company.kecamatan = extractKecamatanFromAlamat(company.alamat);
    }
    
    // Handle kasus khusus berdasarkan nama perusahaan atau alamat
    if (company.namaPerusahaan) {
        const namaLower = company.namaPerusahaan.toLowerCase();
        const alamatLower = (company.alamat || '').toLowerCase();
        
        // Perusahaan dengan "UNIT AMPLAS" tapi di Jakarta
        if (namaLower.includes('unit amplas') && alamatLower.includes('jakarta')) {
            company.kecamatan = 'Lain-lain';
        }
        
        // Perusahaan dengan "LABORATORIUM" di Pekanbaru
        if (namaLower.includes('laboratorium') && alamatLower.includes('pekanbaru')) {
            company.kecamatan = 'Lain-lain';
        }
        
        // Perusahaan dengan "SERDANG BEDAGAI" di alamat
        if (alamatLower.includes('serdang bedagai')) {
            company.kecamatan = 'Lain-lain';
        }
    }
    
    return company;
}

function processCompanyData(company) {
    if (!company.kecamatan && company.alamat) {
        company.kecamatan = extractKecamatanFromAlamat(company.alamat);
    }
    
    // Handle kasus khusus berdasarkan nama perusahaan atau alamat
    if (company.namaPerusahaan) {
        const namaLower = company.namaPerusahaan.toLowerCase();
        
        // Perusahaan dengan "UNIT AMPLAS" tapi di Jakarta
        if (namaLower.includes('unit amplas') && company.alamat && company.alamat.toLowerCase().includes('jakarta')) {
            company.kecamatan = 'Lain-lain';
        }
        
        // Perusahaan dengan "KEBUN" di Medan
        if (namaLower.includes('kebun') && company.alamat && company.alamat.toLowerCase().includes('bangun purba')) {
            company.kecamatan = 'Medan Area'; // atau sesuaikan dengan kecamatan sebenarnya
        }
    }
    
    return company;
}

function capitalizeWords(str) {
    return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
    });
}
       async function loadAllData() {
            updateProgressBar(10, 'Mengambil data dari Google Sheets...');
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.sheetId}/values/${SHEET_CONFIG.range}?key=${SHEET_CONFIG.apiKey}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                updateProgressBar(50, 'Memproses data...');
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('Tidak ada data ditemukan di spreadsheet');
                }
                
                const headers = data.values[0];
                
                allData = data.values.slice(1).map((row) => {
                    const company = {};
                    
                    headers.forEach((header, i) => {
                        const normalizedHeader = header.toLowerCase().trim();
                        const cellValue = row[i] || '';
                        
                        if (normalizedHeader.includes('pemberi kerja') || normalizedHeader.includes('badan usaha') || normalizedHeader.includes('nama perusahaan') || normalizedHeader.includes('perusahaan') || normalizedHeader.includes('instansi')) {
                            company.namaPerusahaan = cellValue;
                        } 
                        else if (normalizedHeader.includes('alamat')) {
                            company.alamat = cellValue;
                        } 
                        else if (normalizedHeader.includes('kecamatan')) {
                            company.kecamatan = cellValue;
                        } 
                        else if (normalizedHeader.includes('skala') || normalizedHeader.includes('usaha')) {
                            company.skalaUsaha = cellValue;
                        } 
                        else if (normalizedHeader.includes('prog') || normalizedHeader.includes('program')) {
                            company.program = cellValue;
                        } 
                        else if (normalizedHeader.includes('tk') || normalizedHeader.includes('aktif') || normalizedHeader.includes('tenaga') || normalizedHeader.includes('kerja')) {
                            let tkValue = cellValue;
                            if (typeof tkValue === 'string') {
                                tkValue = parseInt(tkValue.replace(/[^\d]/g, '')) || 0;
                            } else {
                                tkValue = parseInt(tkValue) || 0;
                            }
                            company.tkAktif = tkValue;
                        }
                    });
                    
                    if (!company.kecamatan && company.alamat) {
                        company.kecamatan = extractKecamatanFromAlamat(company.alamat);
                    } else if (!company.kecamatan) {
                        company.kecamatan = 'Lain-lain';
                    } else {
                         // Pastikan nama kecamatan terkapitalisasi
                        company.kecamatan = capitalizeWords(company.kecamatan);
                    }
                    
                    return company;
                }).filter(company => company.namaPerusahaan);
                
                updateProgressBar(100, 'Data berhasil dimuat!');
                return allData;
                
            } catch (error) {
                console.error('Error fetching data from Google Sheets:', error);
                updateConnectionStatus('error', 'Gagal memuat data');
                showError("Gagal memuat data dari Google Sheets: " + error.message);
                
                allData = [];
                updateProgressBar(100, 'Gagal memuat data');
                return allData;
            }
        }
        
        function updateProgressBar(percent, message) {
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}% - ${message}`;
            }
        }

        function updateDashboard(data) {
            updateSummaryCards(data);
            updateCharts(data);
            updateKecamatanTable(data);
        }

        function updateSummaryCards(data) {
            const totalCompanies = data.length;
            const totalTenagaKerja = data.reduce((sum, company) => {
                let tkAktif = company.tkAktif || 0;
                if (typeof tkAktif === 'string') { tkAktif = parseInt(tkAktif.replace(/[^\d]/g, '')) || 0; }
                return sum + Math.max(0, tkAktif);
            }, 0);

            const elTotal = document.getElementById('totalCompanies');
            const elTotalTenagaKerja = document.getElementById('totalTenagaKerja');

            if (elTotal) elTotal.textContent = totalCompanies.toLocaleString('id-ID');
            if (elTotalTenagaKerja) elTotalTenagaKerja.textContent = totalTenagaKerja.toLocaleString('id-ID');
        }

        function updateCharts(data) {
            updateSkalaChart(data);
            updateProgramChart(data);
        }

        function updateSkalaChart(data) {
    const skalaCounts = {};
    data.forEach(company => {
        let skala = company.skalaUsaha || 'Tidak Diketahui';
        if (skala === 'MI') skala = 'Mi';
        skalaCounts[skala] = (skalaCounts[skala] || 0) + 1;
    });
    const skalaNames = { 'Mi': 'Mikro', 'K': 'Kecil', 'Mn': 'Menengah', 'B': 'Besar', 'Tidak Diketahui': 'Tidak Diketahui' };
    const ORDER = ['Mi', 'K', 'Mn', 'B', 'Tidak Diketahui'];
    const labels = ORDER.map(k => skalaNames[k]);
    const values = ORDER.map(k => skalaCounts[k] || 0);
    const colors = ['#004c99', '#0066cc', '#28a745', '#ffcc00', '#6c757d'];
    if (skalaChart) skalaChart.destroy();
    const ctx = document.getElementById('skalaChart').getContext('2d');
    skalaChart = new Chart(ctx, { 
        type: 'bar', 
        data: { 
            labels, 
            datasets: [{ 
                label: 'Jumlah Perusahaan', 
                data: values, 
                backgroundColor: colors, 
                borderColor: '#ffffff', 
                borderWidth: 1 
            }] 
        }, 
        options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            plugins: { 
                legend: { display: false }, 
                tooltip: { 
                    callbacks: { 
                        label: (ctx) => { 
                            const value = Number(ctx.raw) || 0; 
                            const total = ctx.dataset.data.reduce((a,b)=>a+Number(b||0),0); 
                            const pct = total ? (value/total*100) : 0; 
                            return `${ctx.label}: ${value.toLocaleString('id-ID')} perusahaan (${pct.toFixed(1)}%)`; 
                        } 
                    } 
                } 
            }, 
            scales: { 
                y: { 
                    beginAtZero: true, 
                    ticks: { callback: v => v.toLocaleString('id-ID') } 
                } 
            },
            // Tambahkan ini untuk membuat chart bisa diklik
            onClick: (evt, elements) => {
                if (elements.length > 0) {
                    const index = elements[0].index;
                    const skalaValue = ORDER[index];
                    // Redirect ke halaman detail dengan parameter skala
                    window.location.href = `detail_skala.html?skala=${encodeURIComponent(skalaValue)}`;
                }
            }
        } 
    });

    // Tambahkan style cursor pointer
    ctx.canvas.style.cursor = 'pointer';
}

        function updateProgramChart(data) {
            const programCounts = {};
            data.forEach(company => {
                let program = company.program || 'Tidak Diketahui';
                if (program === 'Tidak Diketahui') program = 'JKK & JKM';
                programCounts[program] = (programCounts[program] || 0) + 1;
            });
            const programNames = { 'JKK & JKM': 'JKK & JKM', '3P': 'JKK, JKM & JHT', '4P': 'JKK, JKM, JHT & JP' };
            const desiredOrder = ['JKK & JKM', '3P', '4P'];
            const allKeys = Object.keys(programCounts);
            const orderedKeys = [...desiredOrder.filter(k => allKeys.includes(k)), ...allKeys.filter(k => !desiredOrder.includes(k)).sort()];
            const labels = orderedKeys.map(k => programNames[k] || k);
            const values = orderedKeys.map(k => programCounts[k]);
            const colorMap = { 'JKK & JKM': '#004c99', '3P': '#0066cc', '4P': '#28a745' };
            const fallbackColors = ['#888888', '#aa66cc', '#ff9933', '#33cccc', '#9966ff'];
            const colors = orderedKeys.map((k, i) => colorMap[k] || fallbackColors[i % fallbackColors.length]);
            if (programChart) programChart.destroy();
            const ctx = document.getElementById('programChart').getContext('2d');
            programChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ data: values, backgroundColor: colors, borderColor: '#ffffff', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (ctx) => { const value = Number(ctx.raw) || 0; const total = ctx.dataset.data.reduce((a, b) => a + Number(b || 0), 0); const pct = total ? (value / total * 100) : 0; return `${ctx.label}: ${value.toLocaleString('id-ID')} perusahaan (${pct.toFixed(1)}%)`; } } } } } });
        }

        function updateKecamatanTable(data) {
            const kecamatanCounts = {};
            data.forEach(company => {
                const kecamatan = company.kecamatan || 'Lain-lain';
                kecamatanCounts[kecamatan] = (kecamatanCounts[kecamatan] || 0) + 1;
            });
            const kecamatanList = [
                "Medan Amplas", "Medan Area", "Medan Barat", "Medan Baru", "Medan Belawan",
                "Medan Deli", "Medan Denai", "Medan Helvetia", "Medan Johor", "Medan Kota",
                "Medan Labuhan", "Medan Maimun", "Medan Marelan", "Medan Perjuangan", "Medan Petisah",
                "Medan Polonia", "Medan Selayang", "Medan Sunggal", "Medan Tembung", "Medan Timur",
                "Medan Tuntungan", "Lain-lain"
            ];
            kecamatanList.forEach(kecamatan => { if (!kecamatanCounts[kecamatan]) { kecamatanCounts[kecamatan] = 0; } });
            const sortedKecamatan = Object.keys(kecamatanCounts).sort((a, b) => {
                if (a === 'Lain-lain') return 1; if (b === 'Lain-lain') return -1; 
                return kecamatanCounts[b] - kecamatanCounts[a];
            });
            const kecamatanTableBody = document.getElementById('kecamatanTableBody');
            kecamatanTableBody.innerHTML = '';
            if (sortedKecamatan.length === 0) {
                kecamatanTableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;padding:20px;color:#666;"><p>Tidak ada data yang tersedia</p></td></tr>`;
                return;
            }
            sortedKecamatan.forEach((kecamatan, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <a href="detail.html?kecamatan=${encodeURIComponent(kecamatan)}" class="instansi-link" data-orig="${kecamatan}">
                            ${kecamatan}
                        </a>
                    </td>
                    <td class="center-text">${kecamatanCounts[kecamatan].toLocaleString('id-ID')}</td>
                `;
                kecamatanTableBody.appendChild(row);
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const formatter = new Intl.DateTimeFormat('id-ID', {
                day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit',
                hourCycle: 'h23', timeZone: 'Asia/Jakarta'
            });
            let formatted = formatter.format(now);
            formatted = formatted.replace('Okt', 'Oct') .replace('Sep', 'Sep') .replace('Agu', 'Aug') .replace('Jul', 'Jul').replace('Jun', 'Jun') .replace('Mei', 'May') .replace('Apr', 'Apr') .replace('Mar', 'Mar').replace('Feb', 'Feb') .replace('Jan', 'Jan').replace(/\./g, ':').replace(/\s\s+/g, ' ');
            const finalString = `Update data per tgl. ${formatted}`;
            const dateElement = document.getElementById('currentDate');
            if (dateElement) { dateElement.textContent = finalString; }
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = message;
            }
        }

        function showError(message) {
             const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `<div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px; border-radius: 8px; z-index: 10000; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                <strong>Error:</strong> ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: 10px;">&times;</button>
            </div>`;
            document.body.appendChild(errorDiv);
            setTimeout(() => { if (errorDiv.parentElement) { errorDiv.remove(); } }, 5000);
        }

        function addRefreshButton() {
            const topBarRight = document.querySelector('.top-bar-right');
            if (topBarRight) {
                const refreshButton = document.createElement('button');
                refreshButton.innerHTML = '🔄 Refresh';
                refreshButton.className = 'nav-button';
                refreshButton.style.cssText = `
                    background: var(--color-surface); color: var(--color-primary; border: none; padding: 6px 12px;
                    border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; transition: all 0.3s ease;
                    margin-left: 10px;
                `;
                refreshButton.onclick = refreshData;
                refreshButton.onmouseover = function() { this.style.background = '#e9eef2'; this.style.transform = 'translateY(-1px)'; };
                refreshButton.onmouseout = function() { this.style.background = 'var(--color-surface)'; this.style.transform = 'translateY(0)'; };
                topBarRight.appendChild(refreshButton);
            }
        }

        function refreshData() {
            updateConnectionStatus('loading', 'Memuat ulang...');
            document.getElementById('progressContainer').style.display = 'block';
            
            loadAllData()
                .then(data => {
                    if (data && data.length > 0) {
                        updateDashboard(data);
                        updateConnectionStatus('online', `${data.length} data berhasil dimuat`);
                        
                        filteredCompanyData = [...allData];

                        const currentTableTitle = document.getElementById('tableTitle').textContent.toLowerCase();
                        if(currentTableTitle.includes('perusahaan')) {
                            currentPage = 1; 
                            updatePerusahaanTablePage(document.getElementById('tableSearch').value.trim().toLowerCase());
                        }

                        const successDiv = document.createElement('div');
                        successDiv.innerHTML = `<div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                            ✅ Data berhasil diperbarui!
                        </div>`;
                        document.body.appendChild(successDiv);
                        setTimeout(() => { if (successDiv.parentElement) { successDiv.remove(); } }, 3000);
                    } else {
                        updateConnectionStatus('error', 'Tidak ada data');
                    }
                    
                    document.getElementById('progressContainer').style.display = 'none';
                })
                .catch(error => {
                    console.error("❌ Error refreshing data:", error);
                    updateConnectionStatus('error', 'Error memuat data');
                    showError("Gagal memperbarui data. Silakan coba lagi.");
                    document.getElementById('progressContainer').style.display = 'none';
                });
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            console.log("🔄 Auto-refreshing data...");
            refreshData();
        }, 5 * 60 * 1000);

        // ==========================================================
        // INISIALISASI
        // ==========================================================
        document.addEventListener('DOMContentLoaded', async () => {
            updateCurrentDate();
            updateConnectionStatus('loading', 'Memuat data...');
            
            try {
                document.getElementById('progressContainer').style.display = 'block';
                
                await loadAllData();
                
                if (allData && allData.length > 0) {
                    updateDashboard(allData);
                    updateConnectionStatus('online', `${allData.length} data berhasil dimuat`);
                    filteredCompanyData = [...allData]; 
                    
                    try {
                        const dataToStore = JSON.stringify(allData);
                        if (typeof(Storage) !== "undefined") {
                            sessionStorage.setItem('companyData', dataToStore);
                        }
                    } catch (e) {
                        console.log("Note: Tidak dapat menyimpan data di session storage");
                    }
                } else {
                    updateConnectionStatus('error', 'Tidak ada data');
                }
                
                document.getElementById('progressContainer').style.display = 'none';
            } catch (error) {
                console.error("❌ Error loading data:", error);
                updateConnectionStatus('error', 'Error memuat data');
                showError("Gagal memuat data dari Google Sheets. Silakan coba lagi.");
                document.getElementById('progressContainer').style.display = 'none';
            }
            
            addRefreshButton();
        });
    </script>
</body>
</html>
