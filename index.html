<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pemberi Kerja/Badan Usaha Kantor Cabang Medan Kota</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        /* CSS tetap sama seperti sebelumnya */
        :root {
            --color-primary: #004c99;
            --color-secondary: #0066cc;
            --color-green: #28a745;
            --color-yellow-accent: #ffc107;
            --color-background: #f0f3f6;
            --color-surface: #ffffff;
            --color-text-dark: #333333;
            --color-text-light: #ffffff;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--color-background);
            color: var(--color-text-dark);
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--color-surface);
            padding: 10px 20px;
            margin-bottom: 10px;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
        }

        .header-section {
            display: flex;
            align-items: center;
        }

        .header-logo {
            height: 80px;
            margin-right: 15px;
            border-radius: 8px;
        }
            
        .header-logo:last-of-type {
            margin-right: 0;
        }

        .header-title {
            text-align: center;
            flex-grow: 1;
        }
            
        .header-title h1 {
            font-size: 1.5rem;
            color: var(--color-primary);
            font-weight: 700;
            margin-bottom: 5px;
        }
            
        .header-title p {
            font-size: 1rem;
            font-weight: 500;
            color: #000000;
            font-style: italic;
        }

        .header-person {
            height: 90px;
            margin-left: 15px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--color-green);
            color: var(--color-text-light);
            padding: 8px 15px;
            margin-bottom: 10px;
            font-weight: 500;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
            
        .home-button, .refresh-button {
            background-color: var(--color-surface);
            color: var(--color-primary);
            padding: 8px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .home-button:hover, .refresh-button:hover {
            background-color: #e9eef2;
            transform: translateY(-2px);
        }

        h2 {
            font-size: 1.6rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--color-primary);
            text-align: center;
        }
        
        .nav-button {
            display: inline-block;
            margin-left: 10px;
            margin-bottom: 10px;
            padding: 10px 12px;
            font-size: 1.5em;
            color: #fff;
            background-color: #004c99;
            border-radius: 6px;
            text-decoration: none;
            transition: background 0.3s;
        }

        .nav-button:hover {
            background-color: #0066cc;
        }

        .panel {
            background-color: var(--color-surface);
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #edf2f7;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .panel .summary-cards {
            display: flex;              
            flex-wrap: wrap;            
            gap: 12px;                  
            width: max-content;
        }

        .panel .summary-cards .card {
            flex: 0 0 auto;             
            display: flex;
            align-items: center;
            gap: 10px;                  
            padding: 10px 14px;         
            text-align: left;           
            min-width: unset;           
        }

        .card.total-tenaga-kerja { 
            background: linear-gradient(135deg, #dc3545, #c82333); 
            color: var(--color-text-light);
        }

        .panel .summary-cards .card h3 {
            margin: 0;
            font-size: 0.95rem;
        }

        .panel .summary-cards .card .value {
            font-size: 1.35rem;
            font-weight: 700;
        }

        .panel .summary-cards .card .currency {
            font-size: 1rem;
            font-weight: 600;
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .dashboard-top {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            align-items: start;
        }
        
        .dashboard-main {
            width: fit-content;   
            max-width: 100%;      
            align-self: flex-start;
            flex: 0 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .dashboard{align-items:flex-start}
        .dashboard-main{
            flex:0 0 auto;         
            width:fit-content;       
            max-width:100%;
            align-self:flex-start;
        }

        .dashboard-main > .panel:first-child{
            display:inline-block;
            width:fit-content;      
            box-sizing:border-box; 
        }

        .dashboard-main > .panel.charts-container{
            width:100%; 
            box-sizing: border-box;   
            grid-template-columns: repeat(2, minmax(280px, 1fr)) !important;   
            display: grid;      
            grid-template-columns: 1fr !important;
            row-gap: 12px;
            column-gap: 12px;
            justify-items: stretch; 
        }

        .dashboard-main > .panel.charts-container .chart-card {
            width: 100%;
            align-self: stretch;
            box-sizing: border-box;
            padding: 12px;
        }

        .dashboard-main > .panel.charts-container .chart-container,
        .dashboard-main > .panel.charts-container canvas {
            width: 100% !important;
        }

        .dashboard-main > .panel.charts-container .chart-container{
            height: 220px;
        }

        .dashboard-main .charts-container { 
            grid-template-columns: 1fr !important;
        }
 
        .dashboard-side {
            flex: 1;
            width: auto;
            min-width: 350px;
            max-width: none;
        }

        .dashboard-main .charts-container { 
            width: 100%; 
            display:grid;
            grid-template-columns: repeat(2, minmax(340px, 1fr));  
            gap:15px;
        }

        .dashboard-main > .panel.charts-container canvas{
            width: 100% !important;
        }

        .dashboard-top {
            display: grid;
            grid-template-columns: max-content 1fr;
            gap: 25px;
            align-items: start;
        }
        
        .dashboard-bottom .data-table-container {
            width: 100%;
        } 
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .summary-cards .card {
            width: 320px;
            padding: 20px 25px;
            align-items: flex-start;
            text-align: left;
        }

        .summary-cards .card h3 {
            font-size: 1.1rem;
        }

        .summary-cards .card .value {
            font-size: 2.4rem;
        }

        .chart-card:has(#statusChart) .chart-container{
            height: 194px;                 
        }
        
        .chart-card:has(#sumberDanaChart){
            padding: 5px;                 
        }

        .chart-card:has(#sumberDanaChart) .chart-container{
            height: 194px;                 
        }
        
        .chart-card:has(#sumberDanaChart){
            padding: 5px;
        }

        .card {
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            color: var(--color-text-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .card.total-projects { 
            background: linear-gradient(135deg, var(--color-green), #20c997); 
        }
        .card.total-value { 
            background: linear-gradient(135deg, var(--color-primary), #0056b3); 
        }
        .card.avg-value { 
            background: linear-gradient(135deg, var(--color-secondary), #0052cc); 
        }
        .card.total-instansi { 
            background: linear-gradient(135deg, var(--color-yellow-accent), #e0a800); 
            color: var(--color-text-dark); 
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }

        .card h3 {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .card .value {
            font-size: 2.2rem;
            font-weight: 700;
        }

        .card .currency {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .chart-card {
            background-color: var(--color-surface);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .chart-card h3 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 1rem;
            color: var(--color-primary);
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 250px;
        }
        
        .data-table-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            height: calc(100vh - 140px);           
            position: relative;
        }


        .data-table th,
        .data-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #edf2f7;
        }
        
        .data-table {
            overflow: visible;        
        }

        .data-table thead {
            position: sticky;
            z-index: 5;               
        }

        .data-table thead th {
            position: sticky;         
            top: 0;
            z-index: 6;
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
        }


        .data-table th.center-text,
        .data-table td.center-text {
            text-align: center;
        }

        .data-table th {
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.3px;
            padding: 12px 15px;
            min-width: 80px;
        }

        .data-table th:nth-child(2) {
            min-width: 200px;
        }

        .data-table th:last-child {
            min-width: 120px;
        }

        .data-table td {
            padding: 5px 7px;
            text-align: left;
            border-bottom: 1px solid #edf2f7;
        }
        
        .data-table tr:nth-child(even) {
            background-color: #f8fafc;
        }

        .data-table tr:hover {
            background-color: #edf2f7;
            transition: background-color 0.2s ease;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .instansi-link {
            color: var(--color-secondary);
            font-weight: 500;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .instansi-link:hover {
            background-color: #e8f0fe;
            color: var(--color-primary);
        }

        .status-indicator {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-online {
            background-color: #d4edda;
            color: #155724;
        }

        .status-loading {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .container,
        #dashboard,
        .dashboard,
        .dashboard-top,
        .dashboard-bottom,
        .dashboard-bottom .panel,
        .dashboard-bottom .data-table-container {
            width: 100%;
        }

        .dashboard-top {
            display: grid;
            grid-template-columns: 360px 1fr; 
            gap: 10px;
            align-items: start;
        }

        .summary-panel { width: 100%; }
        .summary-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: none;   
            width: 100%;
        }

        .dashboard-top .charts-container {
            display: grid !important;
            grid-template-columns: repeat(2, minmax(320px, 1fr)); 
            gap: 20px;
            width: 100%;
        }
        .dashboard-top .charts-container .chart-card,
        .dashboard-top .charts-container .chart-container,
        .dashboard-top .charts-container canvas {
            width: 100% !important;
        }

        .dashboard-bottom .data-table-container {
            width: 100%;
            height: auto;          
            max-height: none;      
        }

        .data-table { 
            width: 100%; 
            min-width: 900px;
            border-collapse: collapse;
        }

        .dashboard-bottom .data-table-container {
            position: relative;
            overflow: auto;
            height: calc(100vh - 140px); 
            --sticky-title-h: 58px;       
        }

        .dashboard-bottom .data-table-container > h2 {
            position: sticky;
            top: 0;
            z-index: 20;
            margin: 0;                           
            padding: 7px 8px;                  
            background: var(--color-surface);    
            border-bottom: 1px solid #edf2f7;
        }

        .dashboard-bottom .data-table-container thead th {
            position: sticky;
            top: var(--sticky-title-h);          
            z-index: 15;                         
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
        }

        .dashboard-bottom .data-table-container tbody td {
            position: relative;
            z-index: 1;
        }

        .container {
            background: var(--color-surface);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;

            position: sticky;
            top: 10px;               
            max-height: calc(100vh - 20px);
            overflow: hidden;      
        }

        .dashboard-bottom .data-table-container {
            flex: 1;
            overflow: auto;
            border: 1px solid #edf2f7;
            border-radius: var(--border-radius);
            max-height: 350px;       
        }

        .dashboard-bottom .data-table-container > h2 {
            position: sticky;
            top: 0;
            z-index: 20;
            margin: 0;
            padding: 10px 15px;
            background: var(--color-surface);
            border-bottom: 1px solid #edf2f7;
        }

        .dashboard-bottom .data-table-container thead th {
            position: sticky;
            top: 50px; 
            z-index: 15;
            background: linear-gradient(135deg, var(--color-primary), #0056b3);
            color: var(--color-text-light);
        }

        .header-bar{
            width: 180px;
            margin-left: 15px;
            margin-right: 15px;
            margin-top: 10px;
        }
        
        /* ================== DESKTOP BESAR (≥1201px) ================== */
        @media (min-width: 1201px) {
            .container {
                position: sticky;
                top: 10px;
                max-height: calc(100vh - 20px);
                overflow: hidden;
                padding: 16px 20px;
            }
            .dashboard-top {
                display: grid;
                grid-template-columns: 360px 1fr;
                gap: 18px;
                align-items: start;
            }

            .dashboard-top .charts-container {
                display: grid !important;
                grid-template-columns: repeat(2, minmax(320px, 1fr));
                gap: 16px;
            }

            .dashboard-bottom .data-table-container {
                max-height: 350px;
                overflow: auto;
            }
        }

        /* ================== TABLET (901px – 1200px) ================== */
        @media (min-width: 901px) and (max-width: 1200px) {
            .container {
                position: sticky;
                top: 8px;
                max-height: calc(100vh - 16px);
                overflow: hidden;
                padding: 12px 16px;
            }

            .dashboard-top {
                display: grid;
                grid-template-columns: 320px 1fr;
                gap: 16px;
                align-items: start;
            }

            .dashboard-top .charts-container {
                display: grid !important;
                grid-template-columns: repeat(2, minmax(280px, 1fr));
                gap: 14px;
            }

            .chart-container { height: 210px; }

            .dashboard-bottom .data-table-container {
                max-height: 320px;
                overflow: auto;
            }
        }

        /* ================== HP (≤900px) ================== */
        @media (max-width: 900px) {
            .container {
                position: static;
                max-height: none;
                overflow: visible;
                padding: 10px;
            }
            .data-table-container {
                max-height: 60vh;
            }
            .summary-cards .card .value {
                font-size: 1.4rem;
            }
            .chart-container {
                height: 180px;
            }
            .header-section { justify-content: center; } 
            .header-bar { height: clamp(12px, 8vw, 40px); }

            .dashboard-top {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .dashboard-main, .dashboard-top, .dashboard-bottom {
                width: 100% !important;
            }

            .summary-cards {
                display: grid !important;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 10px;
                width: 100%;
            }
            @media (max-width: 520px) {
                .summary-cards { grid-template-columns: 1fr; }
            }
            .summary-cards .card {
                width: 100% !important;
                padding: 14px 16px;
                text-align: left;
                align-items: flex-start;
            }
            .summary-cards .card h3 { font-size: 0.95rem; }
            .summary-cards .card .value { font-size: 1.6rem; }

            .dashboard-top .charts-container {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }
            .chart-card { padding: 12px; }
            .chart-container { height: 180px; }

            .dashboard-bottom .data-table-container {
                max-height: 60vh;
                overflow: auto;
                border: 1px solid #edf2f7;
                border-radius: var(--border-radius);
            }

            .dashboard-bottom .data-table-container { --sticky-title-h: 44px; }
            .dashboard-bottom .data-table-container > h2 {
                position: sticky; top: 0; z-index: 20;
                background: var(--color-surface);
                margin: 0; padding: 8px 10px; border-bottom: 1px solid #edf2f7;
            }
            .dashboard-bottom .data-table-container thead th {
                position: sticky; top: var(--sticky-title-h); z-index: 15;
                background: linear-gradient(135deg, var(--color-primary), #0056b3);
                color: var(--color-text-light);
            }

            header { padding: 8px 10px; gap: 8px; }
            .header-title { display: none; }
            .top-bar { flex-direction: column; gap: 6px; padding: 6px 10px; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        /* Progress bar untuk loading data besar */
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 20px;
            background-color: var(--color-primary);
            width: 0%;
            transition: width 0.3s ease;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-section">
                <img src="medan.png" alt="Logo Kota Medan" class="header-logo">
                <img src="pemprovsu.png" alt="Logo Pemprovsu" class="header-logo">
            </div>
            <div class="header-title">
                <h1>Data Pemberi Kerja/Badan Usaha Kantor Cabang Medan Kota</h1>
                <p>(Data Perusahaan Peserta BPJS Ketenagakerjaan)</p>
            </div>

            <div class="header-section">
                <img src="logo.png" alt="Logo BPJS Ketenagakerjaan" class="header-logo">    
            </div>
        </header>
        
        <div class="top-bar">
            <div class="top-bar-left">
                <span id="currentDate"></span>
                <span class="status-indicator status-loading" id="connectionStatus">Memuat...</span>
            </div>
            <div class="top-bar-right">
                <a href="index.html" class="nav-button">Home</a>
                <a href="topworst.html" class="nav-button">Top Worst</a>
            </div>
        </div>

        <div id="dashboard" class="dashboard">
            <div class="dashboard-top">
               <div class="panel summary-panel">
    <div class="summary-cards">
        <div class="card total-projects">
            <h3>Total Perusahaan</h3>
            <div class="value" id="totalCompanies">0</div>
        </div>
        <div class="card total-value">
            <h3>Total Iuran</h3>
            <div class="value currency" id="totalIuran">Rp 0</div>
        </div>
        <div class="card total-tenaga-kerja">
            <h3>Total Tenaga Kerja</h3>
            <div class="value" id="totalTenagaKerja">0</div>
        </div>
    </div>
</div>

                <div class="panel charts-container">
                    <div class="chart-card">
                        <h3>Distribusi Perusahaan Berdasarkan Skala</h3>
                        <div class="chart-container">
                            <canvas id="skalaChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Distribusi Perusahaan Berdasarkan Program</h3>
                        <div class="chart-container">
                            <canvas id="programChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bagian Bawah -->
            <div class="dashboard-bottom">
                <div class="panel data-table-container">
                    <h2>Kecamatan</h2>
                    <div class="progress-container" id="progressContainer" style="display: none;">
                        <div class="progress-bar" id="progressBar">0%</div>
                    </div>
                    <table class="data-table" id="mainDataTable">
                        <thead>
                            <tr>
                                <th>No.</th>
                                <th>Nama Kecamatan</th>
                                <th class="center-text">Jumlah<br>Perusahaan</th>
                                <th class="center-text">Total<br>Iuran</th>
                            </tr>
                        </thead>
                        <tbody id="mainTableBody">
                            <tr>
                                <td colspan="4" style="text-align:center;padding:20px;color:#666;">
                                    <div class="loading-spinner"></div>
                                    <p style="margin-top:10px;">Memuat data...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let skalaChart = null;
        let programChart = null;
        let allData = [];

        // Configuration for Google Sheets API
        const SHEET_CONFIG = {
            sheetId: "1bi7beUHCGem8U7-huUarJY1V1pfTPLqSCRwghMjAehk",
            apiKey: "AIzaSyDDChj-Syqytv2HboLnbflQu7-u_5VAYIE",
            range: "Sheet1!A1:N11000" // Range untuk 11.000 data
        };

        document.addEventListener('DOMContentLoaded', async () => {
            updateCurrentDate();
            updateConnectionStatus('loading', 'Memuat data...');
            
            try {
                // Tampilkan progress bar
                document.getElementById('progressContainer').style.display = 'block';
                
                // Load data dari Google Sheets
                await loadAllData();
                
                if (allData && allData.length > 0) {
                    updateDashboard(allData);
                    updateConnectionStatus('online', `${allData.length} data berhasil dimuat`);
                
                    // Store data untuk penggunaan offline
                    try {
                        const dataToStore = JSON.stringify(allData);
                        if (typeof(Storage) !== "undefined") {
                            sessionStorage.setItem('companyData', dataToStore);
                        }
                    } catch (e) {
                        console.log("Note: Tidak dapat menyimpan data di session storage");
                    }
                } else {
                    console.log("⚠️ Tidak ada data ditemukan");
                    updateConnectionStatus('error', 'Tidak ada data');
                }
                
                // Sembunyikan progress bar
                document.getElementById('progressContainer').style.display = 'none';
            } catch (error) {
                console.error("❌ Error loading data:", error);
                updateConnectionStatus('error', 'Error memuat data');
                showError("Gagal memuat data dari Google Sheets. Silakan coba lagi.");
                
                // Sembunyikan progress bar
                document.getElementById('progressContainer').style.display = 'none';
            }
            
            // Tambahkan tombol refresh
            addRefreshButton();
        });

        async function loadAllData() {
            // Update progress bar
            updateProgressBar(10, 'Mengambil data dari Google Sheets...');
            
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_CONFIG.sheetId}/values/${SHEET_CONFIG.range}?key=${SHEET_CONFIG.apiKey}`
                );
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                updateProgressBar(50, 'Memproses data...');
                
                if (!data.values || data.values.length === 0) {
                    throw new Error('Tidak ada data ditemukan di spreadsheet');
                }
                
                // Ambil header (baris pertama)
                const headers = data.values[0];
                
                // Proses data (mulai dari baris kedua)
                allData = data.values.slice(1).map((row, index) => {
                    const company = {};
                    
                    // Mapping kolom berdasarkan header
                    headers.forEach((header, i) => {
                        // Normalisasi nama header
                        const normalizedHeader = header.toLowerCase().trim();
                        const cellValue = row[i] || '';
                        
                        if (normalizedHeader.includes('nama') && normalizedHeader.includes('perusahaan')) {
                            company.namaPerusahaan = cellValue;
                        } else if (normalizedHeader.includes('alamat')) {
                            company.alamat = cellValue;
                            company.kecamatan = extractKecamatanFromAlamat(cellValue);
                        } else if (normalizedHeader.includes('kecamatan')) {
                            company.kecamatan = cellValue;
                        } else if (normalizedHeader.includes('skala') || normalizedHeader.includes('usaha')) {
                            company.skalaUsaha = cellValue;
                        } else if (normalizedHeader.includes('prog') || normalizedHeader.includes('program')) {
                            company.program = cellValue;
                        } else if (normalizedHeader.includes('tk') || normalizedHeader.includes('aktif') || 
                                   normalizedHeader.includes('tenaga') || normalizedHeader.includes('kerja')) {
                            // Menangani berbagai kemungkinan nama kolom untuk tenaga kerja
                            let tkValue = cellValue;
                            if (typeof tkValue === 'string') {
                                tkValue = parseInt(tkValue.replace(/[^\d]/g, '')) || 0;
                            } else {
                                tkValue = parseInt(tkValue) || 0;
                            }
                            
                            company.tkAktif = tkValue;
                        } else if (normalizedHeader.includes('total') && normalizedHeader.includes('iuran')) {
                            // Parsing khusus untuk total iuran
                            let iuranValue = cellValue;
                            
                            // Jika string, bersihkan dan konversi
                            if (typeof iuranValue === 'string') {
                                iuranValue = iuranValue.replace(/[^\d,.-]/g, '');
                                
                                // Handle berbagai format angka
                                if (iuranValue.includes(',') && iuranValue.includes('.')) {
                                    iuranValue = iuranValue.replace(/\./g, '').replace(',', '.');
                                } else if (iuranValue.includes(',')) {
                                    iuranValue = iuranValue.replace(/,/g, '');
                                }
                                
                                company.nilaiPosting = parseFloat(iuranValue) || 0;
                            } else {
                                company.nilaiPosting = parseFloat(iuranValue) || 0;
                            }
                        } else if (normalizedHeader.includes('nilai') && normalizedHeader.includes('posting')) {
                            let postingValue = cellValue;
                            
                            if (typeof postingValue === 'string') {
                                postingValue = postingValue.replace(/[^\d,.-]/g, '');
                                
                                if (postingValue.includes(',') && postingValue.includes('.')) {
                                    postingValue = postingValue.replace(/\./g, '').replace(',', '.');
                                } else if (postingValue.includes(',')) {
                                    postingValue = postingValue.replace(/,/g, '');
                                }
                                
                                company.nilaiPosting = parseFloat(postingValue) || 0;
                            } else {
                                company.nilaiPosting = parseFloat(postingValue) || 0;
                            }
                        }
                    });
                    
                    if (!company.kecamatan) {
                        company.kecamatan = extractKecamatanFromAlamat(company.alamat);
                    }
                    
                    return company;
                });
                
                updateProgressBar(100, 'Data berhasil dimuat!');
                console.log(`✅ Data loaded: ${allData.length} records`);
                return allData;
                
            } catch (error) {
                console.error('Error fetching data from Google Sheets:', error);
                updateConnectionStatus('error', 'Gagal memuat data');
                showError("Gagal memuat data dari Google Sheets. Silakan periksa koneksi internet atau coba lagi nanti.");
                
                // Tidak menggunakan data sampel, tampilkan pesan error
                allData = [];
                updateProgressBar(100, 'Gagal memuat data');
                return allData;
            }
        }

        function extractKecamatanFromAlamat(alamat) {
            if (!alamat || typeof alamat !== 'string') return 'Lain-lain';
            
            const alamatLower = alamat.toLowerCase();
            
            // Daftar kecamatan di Medan
            const kecamatanList = [
                "medan amplas", "medan area", "medan barat", "medan baru", "medan belawan",
                "medan deli", "medan denai", "medan helvetia", "medan johor", "medan kota",
                "medan labuhan", "medan maimun", "medan marelan", "medan perjuangan", "medan petisah",
                "medan polonia", "medan selayang", "medan sunggal", "medan tembung", "medan timur",
                "medan tuntungan"
            ];
            
            // Cari kecamatan dalam alamat
            for (const kecamatan of kecamatanList) {
                if (alamatLower.includes(kecamatan.toLowerCase())) {
                    return capitalizeWords(kecamatan);
                }
            }
            
            // Fallback: cari dengan pattern lain
            const kecamatanMatch = alamatLower.match(/(medan\s+\w+)/i);
            if (kecamatanMatch) {
                const foundKecamatan = capitalizeWords(kecamatanMatch[1]);
                if (kecamatanList.includes(foundKecamatan.toLowerCase())) {
                    return foundKecamatan;
                }
            }
            
            return 'Lain-lain';
        }
        
        function capitalizeWords(str) {
            return str.replace(/\w\S*/g, function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        function updateProgressBar(percent, message) {
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                progressBar.style.width = `${percent}%`;
                progressBar.textContent = `${percent}% - ${message}`;
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }

        function updateDashboard(data) {
            updateSummaryCards(data);
            updateCharts(data);
            updateMainTable(data);
        }

        function updateSummaryCards(data) {
            const totalCompanies = data.length;
            
            // Total Iuran dari nilaiPosting
            const totalIuran = data.reduce((sum, company) => {
                let nilaiPosting = company.nilaiPosting || 0;
                
                if (typeof nilaiPosting === 'string') {
                    nilaiPosting = nilaiPosting.replace(/[^\d,.-]/g, '');
                    
                    if (nilaiPosting.includes(',') && nilaiPosting.includes('.')) {
                        nilaiPosting = nilaiPosting.replace(/\./g, '').replace(',', '.');
                    } else if (nilaiPosting.includes(',')) {
                        nilaiPosting = nilaiPosting.replace(/,/g, '');
                    }
                    
                    nilaiPosting = parseFloat(nilaiPosting) || 0;
                }
                
                return sum + nilaiPosting;
            }, 0);

            // Perbaikan perhitungan total tenaga kerja
            const totalTenagaKerja = data.reduce((sum, company) => {
                let tkAktif = company.tkAktif || 0;
                
                // Pastikan tkAktif adalah number
                if (typeof tkAktif === 'string') {
                    // Hapus karakter non-digit dan konversi ke number
                    tkAktif = parseInt(tkAktif.replace(/[^\d]/g, '')) || 0;
                }
                
                // Pastikan nilai tidak negatif
                return sum + Math.max(0, tkAktif);
            }, 0);

            const elTotal = document.getElementById('totalCompanies');
            const elTotalIuran = document.getElementById('totalIuran');
            const elTotalTenagaKerja = document.getElementById('totalTenagaKerja');

            if (elTotal) elTotal.textContent = totalCompanies.toLocaleString('id-ID');
            if (elTotalIuran) elTotalIuran.textContent = formatCurrency(totalIuran);
            if (elTotalTenagaKerja) elTotalTenagaKerja.textContent = totalTenagaKerja.toLocaleString('id-ID');

            console.log(`📊 Summary Updated | Perusahaan:${totalCompanies} | Iuran:${formatCurrency(totalIuran)} | Tenaga Kerja:${totalTenagaKerja}`);
        }

        function updateCharts(data) {
            updateSkalaChart(data);
            updateProgramChart(data);
        }

        function updateSkalaChart(data) {
            const skalaCounts = {};
            
            data.forEach(company => {
                const skala = company.skalaUsaha || 'Tidak Diketahui';
                skalaCounts[skala] = (skalaCounts[skala] || 0) + 1;
            });

            // Map skala codes to full names
            const skalaNames = {
                'K': 'Kecil',
                'B': 'Besar',
                'Mn': 'Menengah',
                'Mi': 'Mikro',
                'Tidak Diketahui': 'Tidak Diketahui'
            };

            const labels = Object.keys(skalaCounts).map(skala => skalaNames[skala] || skala);
            const values = Object.values(skalaCounts);

            // Color palette
            const colors = ['#004c99', '#0066cc', '#28a745', '#ffcc00', '#6c757d'];

            if (skalaChart) skalaChart.destroy();

            const ctx = document.getElementById('skalaChart').getContext('2d');
            skalaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Jumlah Perusahaan',
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const value = Number(ctx.raw) || 0;
                                    const total = ctx.dataset.data.reduce((a, b) => a + Number(b || 0), 0);
                                    const pct = total ? (value / total * 100) : 0;
                                    return `${ctx.label}: ${value.toLocaleString('id-ID')} perusahaan (${pct.toFixed(1)}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('id-ID');
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateProgramChart(data) {
            const programCounts = {};
            
            data.forEach(company => {
                const program = company.program || 'Tidak Diketahui';
                programCounts[program] = (programCounts[program] || 0) + 1;
            });

            // Map program codes to full names
            const programNames = {
                '3P': 'JKK, JKM & JHT',
                '4P': 'JKK, JKM, JHT & JP',
                'Tidak Diketahui': 'Tidak Diketahui'
            };

            const labels = Object.keys(programCounts).map(program => programNames[program] || program);
            const values = Object.values(programCounts);

            // Color palette
            const colors = ['#004c99', '#0066cc', '#6c757d'];

            if (programChart) programChart.destroy();

            const ctx = document.getElementById('programChart').getContext('2d');
            programChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#ffffff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const value = Number(ctx.raw) || 0;
                                    const total = ctx.dataset.data.reduce((a, b) => a + Number(b || 0), 0);
                                    const pct = total ? (value / total * 100) : 0;
                                    return `${ctx.label}: ${value.toLocaleString('id-ID')} perusahaan (${pct.toFixed(1)}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateMainTable(data) {
            const kecamatanCounts = {};
            const kecamatanIuran = {};
            
            data.forEach(company => {
                const kecamatan = company.kecamatan || 'Luar Medan';
                kecamatanCounts[kecamatan] = (kecamatanCounts[kecamatan] || 0) + 1;
                
                // Total iuran dari nilaiPosting
                let nilaiPosting = company.nilaiPosting || 0;
                if (typeof nilaiPosting === 'string') {
                    nilaiPosting = parseFloat(nilaiPosting.replace(/[^\d,.-]/g, '')) || 0;
                }
                kecamatanIuran[kecamatan] = (kecamatanIuran[kecamatan] || 0) + nilaiPosting;
            });
            
            // Ensure all 21 kecamatan in Medan are included
            const kecamatanList = [
                "Medan Amplas", "Medan Area", "Medan Barat", "Medan Baru", "Medan Belawan",
                "Medan Deli", "Medan Denai", "Medan Helvetia", "Medan Johor", "Medan Kota",
                "Medan Labuhan", "Medan Maimun", "Medan Marelan", "Medan Perjuangan", "Medan Petisah",
                "Medan Polonia", "Medan Selayang", "Medan Sunggal", "Medan Tembung", "Medan Timur",
                "Medan Tuntungan", "Lain-lain"
            ];
            
            // Add any missing kecamatan with zero counts
            kecamatanList.forEach(kecamatan => {
                if (!kecamatanCounts[kecamatan]) {
                    kecamatanCounts[kecamatan] = 0;
                    kecamatanIuran[kecamatan] = 0;
                }
            });
            
            // Sort by count descending
            const sortedKecamatan = Object.keys(kecamatanCounts).sort((a, b) => kecamatanCounts[b] - kecamatanCounts[a]);
            
            const mainTableBody = document.getElementById('mainTableBody');
            mainTableBody.innerHTML = '';
            
            if (sortedKecamatan.length === 0) {
                mainTableBody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align:center;padding:20px;color:#666;">
                            <p>Tidak ada data yang tersedia</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            sortedKecamatan.forEach((kecamatan, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <a href="detail.html?kecamatan=${encodeURIComponent(kecamatan)}" class="instansi-link">
                            ${kecamatan}
                        </a>
                    </td>
                    <td class="center-text">${kecamatanCounts[kecamatan].toLocaleString('id-ID')}</td>
                    <td class="center-text">${formatCurrency(kecamatanIuran[kecamatan])}</td>
                `;
                mainTableBody.appendChild(row);
            });
        }

        function updateCurrentDate() {
            const now = new Date();
            const options = { 
                day: '2-digit', 
                month: 'short', 
                year: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZone: 'Asia/Jakarta'
            };
            
            document.getElementById('currentDate').textContent = now.toLocaleDateString('id-ID', options);
        }

        function updateConnectionStatus(status, message) {
            const statusElement = document.getElementById('connectionStatus');
            if (statusElement) {
                statusElement.className = `status-indicator status-${status}`;
                statusElement.textContent = message;
            }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.innerHTML = `
                <div style="position: fixed; top: 20px; right: 20px; background: #dc3545; color: white; padding: 15px; border-radius: 8px; z-index: 10000; max-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <strong>Error:</strong> ${message}
                    <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; font-size: 18px; cursor: pointer; margin-left: 10px;">&times;</button>
                </div>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        function addRefreshButton() {
            const topBarRight = document.querySelector('.top-bar-right');
            if (topBarRight) {
                const refreshButton = document.createElement('button');
                refreshButton.innerHTML = '🔄 Refresh';
                refreshButton.className = 'refresh-button';
                refreshButton.style.cssText = `
                    background: var(--color-surface);
                    color: var(--color-primary);
                    border: none;
                    padding: 6px 12px;
                    border-radius: 6px;
                    cursor: pointer;
                    font-weight: bold;
                    font-size: 0.9em;
                    transition: all 0.3s ease;
                    margin-left: 10px;
                `;
                refreshButton.onclick = refreshData;
                refreshButton.onmouseover = function() {
                    this.style.background = '#e9eef2';
                    this.style.transform = 'translateY(-1px)';
                };
                refreshButton.onmouseout = function() {
                    this.style.background = 'var(--color-surface)';
                    this.style.transform = 'translateY(0)';
                };
                topBarRight.appendChild(refreshButton);
            }
        }

        // Function to manually refresh data
        function refreshData() {
            updateConnectionStatus('loading', 'Memuat ulang...');
            
            // Tampilkan progress bar
            document.getElementById('progressContainer').style.display = 'block';
            
            loadAllData()
                .then(data => {
                    if (data && data.length > 0) {
                        updateDashboard(data);
                        updateConnectionStatus('online', `${data.length} data berhasil dimuat`);
                        console.log(`✅ Data refreshed successfully: ${data.length} records`);
                        
                        // Show success message briefly
                        const successDiv = document.createElement('div');
                        successDiv.innerHTML = `
                            <div style="position: fixed; top: 20px; right: 20px; background: #28a745; color: white; padding: 15px; border-radius: 8px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                                ✅ Data berhasil diperbarui!
                            </div>
                        `;
                        document.body.appendChild(successDiv);
                        setTimeout(() => {
                            if (successDiv.parentElement) {
                                successDiv.remove();
                            }
                        }, 3000);
                    } else {
                        updateConnectionStatus('error', 'Tidak ada data');
                    }
                    
                    // Sembunyikan progress bar
                    document.getElementById('progressContainer').style.display = 'none';
                })
                .catch(error => {
                    console.error("❌ Error refreshing data:", error);
                    updateConnectionStatus('error', 'Error memuat data');
                    showError("Gagal memperbarui data. Silakan coba lagi.");
                    
                    // Sembunyikan progress bar
                    document.getElementById('progressContainer').style.display = 'none';
                });
        }

        // Auto-refresh every 5 minutes
        setInterval(() => {
            console.log("🔄 Auto-refreshing data...");
            refreshData();
        }, 5 * 60 * 1000);

        function syncPanelsWidth() {
            const summaryGroup = document.querySelector('.dashboard-main > .panel .summary-cards');
            const chartsPanel  = document.querySelector('.dashboard-main > .panel.charts-container');
            if (!summaryGroup || !chartsPanel) return;

            const summaryPanel = summaryGroup.closest('.panel');
            const w = Math.ceil(summaryPanel.getBoundingClientRect().width);

            chartsPanel.style.width = w + 'px';
        }

        window.addEventListener('load',  syncPanelsWidth);
        window.addEventListener('resize', syncPanelsWidth);
    </script>
</body>
</html>